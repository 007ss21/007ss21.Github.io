"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([[1257],{81318:function(e,t,i){i.d(t,{O1:function(){return s},oO:function(){return l}});var r=i(12922),a=i(94978),n=i(73807),s={416:-499899,401:-499898,403:-499897,404:-499896,timeout:-499895,"4xx":-499894,"5xx":-499893,networkError:-499892,contentError:-499891,mse:-499971,mseOpen:-499972,mseAppend:-499973,boxsError:-499980,moovError:-499981,notH264:-499982,mdatError:-499983,mdhdError:-499984,metaError:-499985,noneURL:-499988,h265Error:-499985,other:-499989,waitTimeout:-499791,onWaitInBufferRange:-499792},o={network:1003,format:1005,runtime:1002,other:9999,demux:1006,remux:1007};var l=(0,r.Z)((function e(t,i,r){(0,a.Z)(this,e);var l=0,d=0;r&&r.range&&r.range.length>1&&(l=r.range[0],d=r.range[1]);var u=function(e){var t=0;switch(e){case 0:t=0;break;case-1:t=s.networkError;break;case-2:t=s.timeout;break;case-3:t=s.contentError;break;default:t=e<500?s[e]||e["4xx"]:s[e]||e["5xx"]}return t}(i);return{errorCode:u,errorType:t,errorTypeCode:o[t],errorMessage:r.httpText||r.message,url:r.url,httpCode:i,version:n.Z,rangeStart:l,rangeEnd:d,ext:r,mediaError:{code:u,message:r.httpText||r.message}}}))},65261:function(e,t,i){i.d(t,{Z:function(){return Ke}});var r=i(97448),a=i.n(r),n=i(44540),s=i.n(n),o=i(63862),l=i.n(o),d=i(66581),u=i.n(d),h=i(90400),f=i.n(h),c=i(33743),m=i.n(c),p=i(12067),g=i.n(p),y=i(84713),v=i.n(y),_=i(39382),T=i.n(_),k=i(11235),b=i.n(k),E=i(54882),S=i.n(E),P=i(70327),R=i.n(P),L=i(38574),x=i.n(L),M=i(10441),w=i.n(M),D=i(18556),I=i.n(D),C=i(26217),A=i.n(C),Z=i(12544),B=i.n(Z),F=i(30562),O=i.n(F),U=i(78650),H=i.n(U),V=i(36210),N=i.n(V),K=(i(86332),i(22032),i(60892),i(15243),i(20145),i(48168),i(86499),i(11757),i(47338),i(47976),i(46818)),W=i(11599),G=i(58200),j=i(94978),q=i(12922),Y=i(47517),z=i(34055),J=i(58010),Q=i(5233),X=i(53560),$=(i(86267),i(18839),i(14652),i(43544),i(83867),i(5304),i(81584),i(67846),i(61396),i(86632),i(82654),i(8356),i(54590),i(32189),i(12551),i(94719),i(96362),i(44148),i(7195),i(92676),i(32543),i(77074),i(75645),i(72831),i(51980),i(52052),i(28374),i(54414),i(91609)),ee=i.n($),te=i(10282),ie=i(7428),re=i(24713),ae=i(72464),ne=i(78066),se=i(45118),oe=i(47859),le=i.n(oe),de=(i(86919),i(21592),i(26592),i(10954),i(8340),i(37920),i(86240),i(78344),i(2517),i(3244),i(60208),i(9368),i(60968),i(43146),i(55507),i(53511),i(68976),i(85653),i(80034),i(29928),i(23914),i(9190),i(71198),i(47146),i(42755),i(14402)),ue=i.n(de),he=i(25726),fe=i(88260),ce=function(){function e(t){(0,j.Z)(this,e),this.drm=t,this.KEYSYSTEM_TYPE="",this.keys={},this.drm.clearKeys&&(this.KEYSYSTEM_TYPE="org.w3.clearkey",this.keys=this.drm.clearKeys),this.options=[],this.ensurePromise=undefined,ue()(this)}return(0,q.Z)(e,[{key:"setOptions",value:function(){var e=[{contentType:'video/mp4; codecs="avc1.42E01E"'},{contentType:'video/webm; codecs="vp8"'}],t={videoCapabilities:e},i={videoCapabilities:e,persistentState:"required",sessionTypes:["persistent-license"]};this.options=[i,t]}},{key:"bail",value:function(e){}},{key:"UpdateSessionFunc",value:function(e){var t=this;return function(i){var r,n=[],s=[];f()(r=a()(e)).call(r,(function(t){var i=e[t],r=he.Z.fromHex(t),a=he.Z.fromHex(i),o={kty:"oct",kid:he.Z.toBase64(r,!1),k:he.Z.toBase64(a,!1)};n.push(o),s.push(o.kid)}));var o={keys:n},l=O()(o);i.target.update(he.Z.StringToArrayBuffer(l)).then((function(){}),t.bail(" MediaKeySession update failed"))}}},{key:"KeysChange",value:function(e){}},{key:"EnsureMediaKeysCreated",value:function(e,t,i){return this.ensurePromise||(this.ensurePromise=navigator.requestMediaKeySystemAccess(t,i).then((function(e){return e.createMediaKeys()}),this.bail(" Failed to request key system access.")).then((function(t){return e.setMediaKeys(t)}),this.bail(" failed to create MediaKeys object"))),this.ensurePromise}},{key:"SetupEME",value:function(e,t){var i=this;e.sessions=[],(0,fe.on)(this,"encrypted",(function(){var t=O()({kids:["0123456789abcdef0123456789abcdef"]}),r=new Uint8Array(he.Z.toUTF8(t));i.EnsureMediaKeysCreated(e,i.KEYSYSTEM_TYPE,i.options).then((function(){var t=e.mediaKeys.createSession();return e.sessions.push(t),t.addEventListener("message",i.UpdateSessionFunc(le()(i))),t.addEventListener("keystatuseschange",i.KeysChange),t.generateRequest("keyids",r.buffer)}),i.bail(" failed to ensure MediaKeys on HTMLMediaElement")).then((function(){}),i.bail(" Failed to generate request."))}))}}]),e}(),me=i(93865),pe=i(67573),ge=i(50685),ye=function(){function e(t,i){(0,j.Z)(this,e),this.cdnHost=t,this.cdnBucket=i}return(0,q.Z)(e,[{key:"init",value:function(){var e=new ge.Z;this.module={onRuntimeInitialized:function(){e.resolve()},onAbort:function(t){e.reject(t)}},this.cdnHost&&(this.module.cdnHost=this.cdnHost);var t=this.cdnBucket?"-".concat(this.cdnBucket):"";return this.module.cdnBucket="media-fe".concat(t),(0,pe.Z)(this.module),e}},{key:"openBox",value:function(e){try{var t=window.atob(e),i=he.Z.str2hex(t),r=this.module._malloc(Number(i.length));this.module.HEAP8.set(i,r);var a=this.module._openBox(Number(r),i.length),n=this.module.UTF8ToString(a);return this.module._free(r),n}catch(s){}}},{key:"destroy",value:function(){this.module=null}}]),e}(),ve=i(31109),_e=i(75557),Te=i(41587),ke={MEDIA_EXPIRED:"MEDIA_EXPIRED",INIT_FAIL:"INIT_FAIL",PARSE_ERROR:"PARSE_ERROR",PLAYER_LOG:"PLAYER_LOG",BUFFERED_RESET:"BUFFERED_RESET"},be=i(90934),Ee=i(4650),Se=i.n(Ee),Pe=(i(38750),i(72579),i(52596)),Re=function(){function e(t,i){var r,a;(0,j.Z)(this,e),this.player=t,this.mediaElem=t.video,this.config=i,this.timer=new Pe.Z,this.prevReadyState=this.mediaElem.readyState,this.didFireLargeGap=!1,this.seekingEventReceived=!1,this.segmentAppended=!1,this.onWaitFunc=w()(r=this._onWaiting).call(r,this),this.onPlayFunc=w()(a=this._onPlay).call(a,this),this.isSafari=/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),!1!==this.config.useGapJump&&this._start(),this.hasPlayed=!1}return(0,q.Z)(e,[{key:"_onWaiting",value:function(){this.onGapJump()}},{key:"_onPlay",value:function(){this.hasPlayed=!0}},{key:"_start",value:function(){this.mediaElem.addEventListener("waiting",this.onWaitFunc),this.mediaElem.addEventListener("play",this.onPlayFunc)}},{key:"onSegmentAppend",value:function(e){if(this.segmentAppended=!0,this.config.enableCheckBufferDiff&&this.mediaElem){var t,i=Se()(e).call(e,(function(e,t){return e+t.downloaded?t[1]-t[0]:0}),0);Se()(t=this._getBuffered(this.mediaElem.buffered)).call(t,(function(e,t){return e+(t.end-t.start)}),0)/i<.8&&((0,be.cM)("onSegmentAppend detectGap"),this.player&&this.player.emit("detectGap"))}this.onGapJump()}},{key:"onSeeking",value:function(){this.seekingEventReceived=!0,this.segmentAppended=!1,this.didFireLargeGap=!1}},{key:"onGapJump",value:function(){if(this.mediaElem.readyState!==HTMLMediaElement.HAVE_NOTHING){if(this.mediaElem.seeking){if(!this.seekingEventReceived)return}else this.seekingEventReceived=!1;if(!this.mediaElem.paused||0===this.mediaElem.currentTime||!this.hasPlayed){this.mediaElem.readyState!==this.prevReadyState&&(this.didFireLargeGap=!1,this.prevReadyState=this.mediaElem.readyState);var t=this.mediaElem.buffered,i=this.config.smallGapLimit||.5,r=this.config.gapDetectionThreshold||.1,a=this.mediaElem.currentTime,n=this._getIndex(t,a,r);if(null!==n&&(0!==n||this.segmentAppended)){var s=t.start(n)+.1;if(!(s>this.mediaElem.duration)){var o=s-a,l=o<=i;o<e.BROWSER_GAP_TOLERANCE||l&&(!0!==this.config.disableGapSetPosition&&((0,be.cM)("onGapJump this.mediaElem.currentTime"),this.mediaElem.currentTime=this.isSafari?s+.1:s),this.player&&this.player.emit("detectGap"),(0,be.cM)("gapJump gapIndex",n,"isGapSamll",l,"jumpLargeGap",!1,"currentTime",this.mediaElem.currentTime),.08!==s&&this.player&&this.player.emit("log",{type:"oneevent",end_type:"gap",vid:this.player.config.vid,ext:{video_postion:Math.floor(1e3*s)}}))}}}}}},{key:"_getIndex",value:function(e,t,i){if(!e||!e.length)return null;if(1===e.length&&e.end(0)-e.start(0)<1e-6)return null;for(var r=this._getBuffered(e),a=null,n=0;n<r.length;n++){if(r[n].start>t&&(0===n||r[n-1].end-t<=i)){a=n;break}}return a}},{key:"_getBuffered",value:function(e){if(!e)return[];for(var t=[],i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}},{key:"destroy",value:function(){this.mediaElem.removeEventListener("waiting",this.onWaitFunc),this.mediaElem.removeEventListener("play",this.onPlayFunc),this.timer.clear(),this.timer=null}}]),e}();Re.BROWSER_GAP_TOLERANCE=.001;var Le=i(81318),xe=i(73807),Me=i(36387),we="FIXED",De="AUTO",Ie=function(){function e(t,i){var r=this;(0,j.Z)(this,e),(0,X.Z)(this,"_onAbrChange",(function(e,t,i,a){var n=r.bitrateMap[e],s=r.bitrateMap[t],o=n.definition;o!==(s&&s.definition?s.definition:o)&&r._abrSwitchHandler(s)})),(0,X.Z)(this,"_onAutoDescChange",(function(e){var t=e.definition,i=e.reset,a=e.fps,n=e.item;r.updateAutoDefiDesc(t,i,a,n)})),this._pluginInst=t;var a=this._pluginInst.config.autoBitrateOpts||{};this.isPlayAutoDefi=Me.ZP.getIsPlayAutoDefi(a),this.isOpenAutoDefi=!!a.isOpenAutoDefi,this.isCurrentAutoDefi=this.isOpenAutoDefi&&this.isPlayAutoDefi,this.bitrateMap={},this.defiIdMap={},this._abrSwitchHandler=i}var t;return(0,q.Z)(e,[{key:"_destroyAbr",value:function(){var e=this._pluginInst.player;this.abrInstance&&(e&&e.off(Me._c.UPDATE_AUTO_DESC,this._onAutoDescChange),this.abrInstance.destroy(),this.abrInstance=null)}},{key:"init",value:(t=(0,G.Z)(ee().mark((function e(t){var i,r,a,n;return ee().wrap((function(e){for(var s;;)switch(e.prev=e.next){case 0:if(this.isOpenAutoDefi){e.next=2;break}return e.abrupt("return",{type:we});case 2:return i=this._pluginInst,r=i.player,a=i.playerConfig,n=i.config,r.on(Me._c.UPDATE_AUTO_DESC,this._onAutoDescChange),this.bitrateMap={},this.defiIdMap={},this.abrInstance=new Me.ZP(r,n,0,{dynamic_video_list:S()(s=a.definition.list).call(s)},5e3,{logger:be.cM,openLog:!0}),e.next=10,this.abrInstance.init(t);case 10:r.on(Me._c.ABR_CHANGE,this._onAbrChange),this.abrInstance.isCurrentInAbr=this.isCurrentAutoDefi;case 12:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"execute",value:function(){var e=this.abrInstance.execute();return{bitrate:e,type:-1===e?we:De}}},{key:"updateBitrate",value:function(e){this.abrInstance&&this.abrInstance.updateBitrate(e)}},{key:"enable",value:function(){this.abrInstance.start(),this.isCurrentAutoDefi=!0,this.abrInstance.isCurrentInAbr=!0,this.abrInstance._onTimeUpdate(null,!0)}},{key:"disable",value:function(){this.abrInstance&&(this.updateAutoDefiDesc("",!0),this.isCurrentAutoDefi=!1,this.abrInstance.isCurrentInAbr=!1,this.abrInstance.stop(!0))}},{key:"isCurrentInAbr",value:function(){return!!this.abrInstance&&this.abrInstance.isCurrentInAbr}},{key:"updateAutoDefiDesc",value:function(e){var t=arguments.length>1&&arguments[1]!==undefined&&arguments[1],i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:undefined,r=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null,a=this._pluginInst,n=a.player,s=a.config,o=s.autoBitrateOpts||{},l=o.autoDefiText||"auto";n.emit("ABR_AUTO_DESC_CHANGE",l,t?undefined:e,i,r)}},{key:"updateAbrCacheData",value:function(){var e=this,t=this._pluginInst,i=t.player,r=t.config,a=t.playerConfig,n=r.autoBitrateOpts||{},s=a.definition.list;if(f()(s).call(s,(function(t){e.bitrateMap[t.bitrate]={url:t.url,definition:t.definition,definitionName:t.text},e.defiIdMap[t.definition]={bitrate:t.bitrate,definition:t.definition}})),this.isOpenAutoDefi,this.isOpenAutoDefi){var o=n.autoDefiText||"auto",l={definition:"\u81ea\u52a8",bitrate:i.curDefinition.bitrate,text:o,url:"__auto__",selected:this.isPlayAutoDefi,name:"\u81ea\u52a8",vwidth:i.curDefinition.vwidth,vheight:i.curDefinition.vheight};a.definition.list.push(l)}}},{key:"destroy",value:function(){this._pluginInst.player.off(Me._c.ABR_CHANGE,this._onAbrChange),this._destroyAbr()}}]),e}(),Ce=i(91519);function Ae(e,t){var i=a()(e);if(s()){var r=s()(e);t&&(r=l()(r).call(r,(function(t){return u()(e,t).enumerable}))),i.push.apply(i,r)}return i}function Ze(e){for(var t=1;t<arguments.length;t++){var i,r,a=null!=arguments[t]?arguments[t]:{};t%2?f()(i=Ae(Object(a),!0)).call(i,(function(t){(0,X.Z)(e,t,a[t])})):m()?g()(e,m()(a)):f()(r=Ae(Object(a))).call(r,(function(t){v()(e,t,u()(a,t))}))}return e}function Be(e){var t=function(){if("undefined"==typeof Reflect||!T())return!1;if(T().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(T()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=(0,Q.Z)(e);if(t){var a=(0,Q.Z)(this).constructor;i=T()(r,arguments,a)}else i=r.apply(this,arguments);return(0,J.Z)(this,i)}}var Fe=null,Oe=null,Ue=null,He=null,Ve="h264",Ne="h265",Ke=function(e){(0,z.Z)(n,e);var t,i,r=Be(n);function n(e){var t,i;return(0,j.Z)(this,n),i=r.call(this,e),(0,X.Z)((0,Y.Z)(i),"_replayHook",(function(e){"xgmse-video"===i.player.config.mediaType?i._onReplay():i.useVideoLoad||(i._startProgress(),i.log("replay start load"),i.player.play())})),(0,X.Z)((0,Y.Z)(i),"_retryHook",(function(){var e=(0,Y.Z)(i),t=e.player,r=e.playerConfig,a=t.currentTime;if(i.codecType===Ne)i._onDegrade("retry");else{if(i.useVideoLoad=!0,"Array"===te.Z.typeOf(r.url)){var n=r.url.length;t.video.src=r.url[n-1].src}else t.video.src=r.url;t.currentTime=a,t.play()}})),(0,X.Z)((0,Y.Z)(i),"_playHook",(function(e){i._usePaused=!1})),(0,X.Z)((0,Y.Z)(i),"_pauseHook",(function(e){i._usePaused=!0})),(0,X.Z)((0,Y.Z)(i),"abrSwitchURL",function(){var e=(0,G.Z)(ee().mark((function e(t){var r,a,n,s,o,l;return ee().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=(0,Y.Z)(i),a=r.playerConfig,n=a.definition.list,s=0,o=0;case 4:if(!(o<n.length)){e.next=11;break}if(t.definition!==n[o].definition){e.next=8;break}return s=o,e.abrupt("break",11);case 8:o++,e.next=4;break;case 11:l=i.player.curDefinition,i.changeDefinition(n[s],l,!0);case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),(0,X.Z)((0,Y.Z)(i),"_onPlaying",(function(){i._waitAdjustTimeCnt>0&&i._waitInBufferTimer&&(i._waitAdjustTimeCnt-=1,i.log("[waitInBuffer resume play], waitAdjustTimeCnt,",i._waitAdjustTimeCnt)),clearTimeout(i._waitInBufferTimer),i._waitInBufferTimer=null,i.log("[Index] onPlaying, timeNow,",he.Z.nowTime());var e=(0,Y.Z)(i),t=e.mp4,r=e.player,a=i.config.resumePlayWaterLevel;if(t){if(!i.playFlag||r.currentTime<1)i.playFlag=!0;else if(!(t&&t.meta&&t.meta.duration-r.currentTime<=a)&&a>0&&i.playFlag){var n=r.getBufferedRange(r.buffered2);n[1]-r.currentTime<a?(r.paused||(r.pause(),i.log("[!!!!!buffer not rich, pause],time,",he.Z.nowTime(),", currentTime, ",r.currentTime,", bufferEnd,",n[1])),clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=b()(i._onPlaying,a/2*1e3)):r.paused&&(i.log("[!!!!!buffer rich, play],time,",he.Z.nowTime(),", currentTime, ",r.currentTime,", bufferEnd,",n[1]),clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,r.play())}}else i.checkResumePlayTimer>0&&(clearTimeout(i.checkResumePlayTimer),i.checkResumePlayTimer=null,r.paused&&r.play())})),(0,X.Z)((0,Y.Z)(i),"_lowDecoder",(function(){var e="function"==typeof i.player.video.getStats?i.player.video.getStats():null;i.log("H265 lowdecode: ".concat(i.playerConfig.vid," "),e,", h265Degrade, ",i.config.h265Degrade),i.config.h265Degrade&&i._onDegrade()})),(0,X.Z)((0,Y.Z)(i),"_onError",(function(e){i._onDegrade(e)})),(0,X.Z)((0,Y.Z)(i),"_onDegrade",(function(e){i.player.video.removeEventListener("lowdecode",i._onDegrade),i.player.video.removeEventListener("error",i._onError),i.mp4&&i.mp4.destroy();var t=i.player.currentTime;i.emit("H265_DEGRADE",{reason:e?"error":"lowdecode",currentTime:t});var r=i.config;r.drm=i.H264Config?i.H264Config.drm:null,r.getLicenseUrl=i.H264Config?i.H264Config.getLicenseUrl:null,r.kid=i.H264Config?i.H264Config.kid:null,r.keyValue=i.H264Config?i.H264Config.keyValue:null,r.secretKey=i.H264Config?i.H264Config.secretKey:null,r.isEncrypt=i.H264Config?i.H264Config.isEncrypt:null,r.useEME=i.H264Config?i.H264Config.useEME:null;var a={mp4encryptplayer:r,mediaType:"video",codecType:Ve};i.player.config.definition.list=i.playerConfig.H264DefinitionList,i.player.playNext(a),i.player.currentTime=t})),(0,X.Z)((0,Y.Z)(i),"_onMp4MetaReady",(function(e){var t;i.firstFrameTime.metaload=i.mp4.firstFrameTime.metaload,i.firstFrameTime.bitrate=i.player.curDefinition.bitrate;var r=i.playerConfig.vid,a=i._checkMetaInfo(e),n=i.mp4.checkCodecH265();if(i.changeState("MP4_META_READY",{is265:n?1:0}),a)i._errorHandler(a);else{try{if(i._initEME(i.mp4,e),i.codecType===Ne){if(!n);i._initH265MseProxy()}else{if(n);i._initMse()}i._initPromise.resolve()}catch(l){var s=new ie.ZP(i.player,{errorType:"runtime",errorTypeCode:1002,errorCode:Le.O1.other,errorMessage:l?l.message:"",vid:r,mediaError:{code:Le.O1.other,message:l?l.message:""}});i._errorHandler(s)}var o=[];R()(t=i.mp4.timeRange).call(t,(function(e){return o.push({startTime:e.startTime,endTime:e.endTime}),!0})),i.emit("KEYFRAMETIME",o),i._loadData()}})),(0,X.Z)((0,Y.Z)(i),"_onMp4Error",(function(e){i.playerConfig.vid;i.changeState("MP4_META_ERROR"),i._errorHandler(e)})),(0,X.Z)((0,Y.Z)(i),"_onMp4Progress",(function(e){i.emit("progress_event",e)})),(0,X.Z)((0,Y.Z)(i),"_onMp4DataCallBack",(function(){i.mse&&!i.mse._mseAppendFlag&&i.openMSE(),i._isMseInit&&i._onTimeUpdate()})),(0,X.Z)((0,Y.Z)(i),"_onVideoTimeUpdate",(function(){i.useVideoLoad||null!==i._requestTimer||i._startProgress(),i.useVideoLoad&&i.checkIfCanPreload()})),(0,X.Z)((0,Y.Z)(i),"_onBufferedReset",(function(e){i.mp4&&i.mp4.videoTrak&&i.mp4.resetFragmentLoadState(0)})),(0,X.Z)((0,Y.Z)(i),"_onOnlineHandler",(function(){var e=(0,Y.Z)(i).config;i.log("online useVideoLoad:",i.useVideoLoad,i._hasStartProgressBack),i.useVideoLoad?i.player.src=e._mainURL:(i._hasStartProgressBack&&i._startProgress(),i._hasStartProgressBack=!1)})),(0,X.Z)((0,Y.Z)(i),"_onOfflineHandler",(function(){i.log("offline, ",i._hasStartProgress),i._hasStartProgress&&(i._stopProgress(),i._hasStartProgressBack=!0)})),(0,X.Z)((0,Y.Z)(i),"_loadDataSuccess",(function(e){if(!i.isDestroy&&(i.mse||i.mseProxy)){e.state&&i._firstSegState<0&&(i._firstSegState=1),i.log("[loadFragment] _loadDataSuccess ",e.context.range,",dataLen,",e.buffer?e.buffer.byteLength:0),i.firstFrameTime.startload_stmux<0&&(i.firstFrameTime.startload_stmux=i.mp4.firstFrameTime.startMuxTime,i.firstFrameTime.firstmux=i.mp4.firstFrameTime.firstmux),i.firstFrameTime.loadst_loadeddata<0&&(i.firstFrameTime.loaddata=he.Z.nowTime()-i.loadstart);try{e.initSeg&&(i._appendInitSeg(e.initSeg),(!e.buffer||e.buffer.byteLength<1)&&(i.log("no data, must load data"),i._onTimeUpdate()));var t=e.buffer,r=e.state,a=e.context,n=e.videoTrack,s=e.audioTrack;if(i.mse&&r&&(!t||t.byteLength<=0)&&a.fragIndex===i.mp4.timeRange.length-1){var o=i.player.buffered;i.bufferEndTime=o.end(o.length-1),i._isEnded(),i.log("loaded ended !!!==>>>",a.range,", fragIndex,",a.fragIndex,", bufferEndTime,",i.bufferEndTime,",meta_duration,",i.mp4.meta.duration)}if(t&&i.mse){if(t&&t.byteLength>0){i._appendBuffer(ne.wF.VIDEO,t,a,r);var l=i.getDataBitRate(a.fragIndex);i.player.emit("addVideoBufferEnd",{start:Math.floor(a.timeRange[0]),end:a.timeRange[1],bandwidth:l.bitrate})}}else if(i.mseProxy&&(n&&n.samples.length>0||s&&s.samples.length>0)){var d=n.samples.length>0?n.samples[0].sampleOffset:-1,u=n.samples.length>0?n.samples[n.samples.length-1].sampleOffset:-1,h=s.samples.length>0?s.samples[0].sampleOffset:-1,f=s.samples.length>0?s.samples[s.samples.length-1].sampleOffset:-1;i.log("[livevideo] appendBuffer,index,",a.fragIndex,",range,",e.context.range,",videoIdxRange,",d,"-",u,",audioIdxRange,",h,"-",f,", timeRange,",a.timeRange),i.mseProxy.appendBuffer(n,s)}}catch(m){i.changeState("APPEND_DATA_ERROR"),i.log("appendBuffer error",m);var c=new ie.ZP(i.player,{errorType:"runtime",errorTypeCode:1002,errorCode:Le.O1.mse,vid:i.player.config.vid,errorMessage:m.message,mediaError:{code:Le.O1.mse,message:m.message}});i._errorHandler(c)}}})),(0,X.Z)((0,Y.Z)(i),"_loadDataFail",(function(e){i.isDestroy||(i.log("_errorHandle5",e),i._errorHandler(e))})),(0,X.Z)((0,Y.Z)(i),"_onWaiting",(function(){var e=(0,Y.Z)(i),t=e.player,r=e.config,a=e.playerConfig;clearTimeout(i._waitInBufferTimer),i._waitInBufferTimer=null;var n=t.currentTime,s=t.bufferedPoint;s.end>0&&s.end-t.currentTime>=2&&(i._waitAdjustTimeCnt<r.waitJampBufferMaxCnt?i._waitInBufferTimer=b()((function(){i._waitAdjustTimeCnt++,t.currentTime=t.currentTime+.5,i.log("[waitInBufferTimeout], waitAdjustTimeCnt,",i._waitAdjustTimeCnt,",curtime,",n,he.Z.nowTime())}),r.waitingInBufferTimeOut):i._errorHandler(new ie.ZP(i.player,{errorType:"waitInBuffer",errorTypeCode:1002,errorCode:Le.O1.onWaitInBufferRange,errorMessage:"onWait_in_buffer",vid:a.vid,mediaError:{code:Le.O1.onWaitInBufferRange}})))})),(0,X.Z)((0,Y.Z)(i),"_onEnded",(function(){i.log("[player.onEnded], stopProgress"),i.player&&i.off("waiting",i._onWaiting),i._stopProgress()})),(0,X.Z)((0,Y.Z)(i),"_onReplay",(function(){var e=(0,Y.Z)(i),t=e.playerConfig,r=e.player;i._reset(),i._init(t.url).then((function(e){var t=e[0],a=e[1];r.video.src=a.url,i._startProgress(),i.mp4=t,i.mse=a,i.log("_replay play"),i.once("canplay",(function(){r.play(),i.on("waiting",i._onWaiting)}))}),(function(e){i.log("_errorHandler6",e),i._errorHandler(e)}))})),(0,X.Z)((0,Y.Z)(i),"_onSeeking",(function(){if(!i.useVideoLoad){var e=(0,Y.Z)(i).player,t=e.currentTime;if(i.log("[seekTime], curTime,",t,",buffer,",i.player.buffered2.bufferedList),i.mp4&&i.mp4.meta){i.endofstream=!1,i.mp4.bufferLoadedPos=-1,i.mp4._metaLoading=!1;var r=e.bufferedPoint,a=!1,n=0;r.end>0&&(a=!0,i.mp4.seekTime=r.end,(n=i.mp4.getFragmentIdx(r.end))<0&&(n=i._curLoadSegmentIdx),i.log("[seeking in buffered range], seekTime ",t,",bufferRange,",r.start,"-",r.end,", fragIndex,",n)),a||(i.mp4.seekTime=t,(n=i.mp4.getFragmentIdx(t))<0&&(n=i._curLoadSegmentIdx),i.log("[seekTime out buffer range], curTime,",t,", Idx,",n)),i.mp4._metaLoading?i.mp4._seekIdxWhenLoadingMoov=n:i.mp4.MP4Loader&&i.mp4.MP4Loader.cancel(),i.mp4.resetFragmentLoadState(n),i._curLoadSegmentIdx=n,i._onTimeUpdate(),i._isEnded()}}})),(0,X.Z)((0,Y.Z)(i),"_onMp4Init",(function(){var e=(0,Y.Z)(i),t=e.player;e.config.mp4Init&&t.pause()})),i._pendingPromises=[],i._allInitPromise=new ge.Z,i._isInit=!1,i._isEventInit=!1,i.playerId=i.player._pluginInfoId,i.preloader=null,i.gapJumpInst=null,i.log("playerId",i.playerId),i._tickInSeconds=i.config.tickInSeconds,i.awManager=null,i._useVideoLoad=!1,i.mse=null,i.mp4=null,i.eme=null,i._isMseInit=!1,i._awPromise=null,i._corePromise=null,i._initPromise=null,i._hasStartProgress=!1,i._hasStartProgressBack=!1,i._maxBufferLength=i.config.maxBufferLength,i._minBufferLength=i.config.minBufferLength,i._maxPausedBufferLength=i.config.maxPausedBufferLength,i._curLoadSegmentIdx=0,i._abrService=null,i._checkRemoveBufferLastTime=he.Z.nowTime(),i.playFlag=!1,i.config.resumePlayWaterLevel=Math.min(i.config.minBufferLength,i.config.resumePlayWaterLevel),i.checkResumePlayTimer=null,i.loadstart=-1,i._loadStartEventTime=-1,i._waitAdjustTimeCnt=0,i._waitInBufferTimer=null,i._firstSegState=-1,i.codecType=i.playerConfig.codecType?i.playerConfig.codecType.toLowerCase():Ve,i.playerConfig.vtype&&(i._vtype=i.playerConfig.vtype.toUpperCase()),i.firstFrameTime={newplayer:he.Z.nowTime(),newplayer_initkernel:-1,initkernel_initmp4:-1,initmse_sbopen:-1,mseopen:-1,initmse_sbopendone:-1,metaload:-1,metaready_mseisopen:-1,metaready_initsegend:-1,startload_stmux:-1,firstmux:-1,apcnt:0,aplen:0,data_ap:-1,loadst_loadeddata:-1,loaddata:-1,new_loadeddata:-1,bitrate:-1},i.states=[],i.removeVideo=null,i._lastCheckTime=he.Z.nowTime(),i.preLoadData=null,i.forPreloadTimeCache=null,i._usePaused=!1,i.endofstream=!1,i.bufferEndTime=-1,i.hitpreload=!1,window&&x()(t=window.location.href).call(t,"playerInstance=true")>-1&&(window.mp4PlayerInstanceList===undefined&&(window.mp4PlayerInstanceList=[]),window.mp4PlayerInstanceList.push(i.player)),i}return(0,q.Z)(n,[{key:"afterCreate",value:function(){var e=this,t=this.playerConfig,i=this.config,r=this.player;i.width=t.width||0,i.height=t.height||0,t.vid=t.vid||i.vid,ne.ZP.isSupported('video/mp4; codecs="avc1.64001E, mp4a.40.5"')&&((0,ve.KI)()||(i.useEME=!1),this.checkConfig(),i.onlyInit&&(t.autoplay=!1,t.videoInit=!1,this._hasStartProgress=!1,this._hasStartProgressBack=!1),t.useWaterLevel&&(!t.userGestureEventMiddleware&&(t.userGestureEventMiddleware=fe.Ru),!t.videoEventMiddleware&&r.setEventsMiddleware(fe.f4)),this.gapJumpInst=new Re(this.player,this.playerConfig),this.preloader=i.isOpenPreload?new Te.ZP(this.config,this,this.bitRateAdapter):null,r.preloader=this.preloader,this._proxyPlayer(),this.initAwManager(),r.useHooks("replay",this._replayHook),r.useHooks("play",this._playHook),r.useHooks("pause",this._pauseHook),r.useHooks("retry",this._retryHook),r.video.addEventListener(ke.BUFFERED_RESET,this._onBufferedReset),this._bindNetworkStateChange(),this.on(re.TIME_UPDATE,this._onVideoTimeUpdate),this.on(re.LOADED_DATA,(function(){e.changeState("LOADED_DATA"),e.deleteVideo(),e._firstSegState=2,e._onTimeUpdate(),e._firstFrameTime()})),this.on(re.LOAD_START,(function(){e.changeState("LOAD_START"),e._loadStartEventTime=he.Z.nowTime(),e.codecType===Ne&&(e._isMseInit=!0,e._onTimeUpdate())})),this.on("xglog",(function(t){if("firstFrame"===t.eventType){e.preLoadData&&e.preLoadData.definition&&e.preLoadData.definition;e.codecType}})),r.mp4MseFlag=!0)}},{key:"_startBufferCheck",value:function(){var e=this.player;if(e.video){var t=[];if(e.video.buffered){for(var i=0,r=e.video.buffered.length;i<r;i++)t.push([e.video.buffered.start(i),e.video.buffered.end(i)]);t.toString()!==this.lastBuffer&&(this.lastBuffer=t.toString(),this._onBufferReachThreshold())}}}},{key:"_onBufferReachThreshold",value:function(){var e=this.player,t=this.config;if(e.video){for(var i=e.video.buffered,r=0,a=0,n=0;n<i.length&&(r=i.start(n),a=i.end(n),!(r<=e.video.currentTime&&e.video.currentTime<=a));n++);a-e.video.currentTime>=t.bufferThreshold&&!this._hasTriggerBufferThreshold&&(this._hasTriggerBufferThreshold=!0,e.emit("BUFFER_THRESHOLD",a-e.video.currentTime))}}},{key:"_startUrlExpiredCheck",value:function(){var e=this.player.config;e.definition&&e.definition.list&&e.definition.list.length>0&&(this.urlExpireTimestamp=e.definition.list[0].url_expire||0,this._handleUrlExpire())}},{key:"checkConfig",value:function(){var e=this.playerConfig,t=this.config,i=e.defaultDefinition,r=e.defaultBitrate;if(!i){var a=this.playerConfig.definition;i=a&&a.defaultDefinition?a.defaultDefinition:t.definition}!r&&t.bitrate&&(r=t.bitrate),e.defaultDefinition=i,e.defaultBitrate=r}},{key:"beforePlayerInit",value:function(){var e=this.player,t=this;this._isInit||(ae.ZP.defineGetterOrSetter(e,{__url:{get:function(){return t.mse?t.mse.url:e.config.url},configurable:!0},downloadSpeed:{get:function(){return se.Z.realTimeSpeed/8/1024},configurable:!0},playerVersion:{get:function(){return xe.Z},configurable:!0},menuCodeType:{get:function(){return t.mp4&&t.mp4.meta?t.mp4.meta.videoCodec:"avc"},configurable:!0},playerType:{get:function(){return"MP4"},configurable:!0},supportMenus:{get:function(){return{speed:e.mp4MseFlag,cdn:e.mp4MseFlag,resolution:e.mp4MseFlag}},configurable:!0},CDNUrl:{get:function(){return t.CDNUrl},configurable:!0}}),this._isInit=!0)}},{key:"destroy",value:function(){var e=this.player;this.preloader&&this.preloader.destroy(this.playerId),e.preloader=null,e.removeHooks("replay",this._replayHook),e.removeHooks("play",this._playHook),e.removeHooks("pause",this._pauseHook),e.removeHooks("retry",this._retryHook),this._reset(),this._onDestroyWasm(),this.player.playNext=Fe,this.player._startInit=Oe,this.player.changeDefinition=Ue,this.player.switchURL=He,this._unbindNetworkStateChange(),e.video&&e.video.removeEventListener(ke.BUFFERED_RESET,this._onBufferedReset)}},{key:"initAwManager",value:function(){var e=this,t=this.config;this.awManager||(this.awManager=new ye(t.cdnHost,t.cdnBucket));var i=new ge.Z;if(i.id="aw",this._awPromise=i,t.isEncrypt){var r=new me.Z;r.push(this.awManager.init()),r.startup().then((function(){r.destroy(),i.resolve()})).catch((function(t){r.destroy(),e._emitInitFail(t),i.reject()}))}else i.resolve()}},{key:"_proxyPlayer",value:function(){var e,t,i,r=this;"function"==typeof this.player.playNext&&(Fe=this.player.playNext),this.player.playNext=function(){r.playNext.apply(r,arguments)},Oe=this.player._startInit,He=this.player.switchURL,Ue=this.player.changeDefinition,this.player._startInit=w()(e=this.playerStartInit).call(e,this),this.player.switchURL=w()(t=this.switchURL).call(t,this),this.player.changeDefinition=w()(i=this.changeDefinition).call(i,this)}},{key:"getInitBitrate",value:function(){var e=this,t=this.player,i=this.config,r=this.playerConfig,a=null,n=t.definitionList;if(n&&n.length>0){if(I()(n).call(n,(function(t){var i=Te.ZP.generateUniqueKey({vid:r.vid,definition:t.definition||"",vtype:r.vtype,codecType:r.codecType});t.cacheKey=i,i&&!a&&e.preloader&&e.preloader.hasItemSameVid(i)&&((a=t).type="preload")})),a&&r.userSelectDefinition&&i.focusUserDefinition)r.userSelectDefinition!==a.definition&&(a=null);!a&&this.bitRateAdapter&&(this.bitRateAdapter.speed=se.Z.speed,(a=this.getDefinitonFromAdapter(n,r.userSelectDefinition))&&(a.type="bitRateAdapter"))}return a&&a.url||(a="Array"===te.Z.typeOf(r.url)&&r.url.length>0||"String"===te.Z.typeOf(r.url)&&r.url?{url:r.url,definition:r.defaultDefinition,duration:r.duration||this.config.duration||0,bitrate:r.defaultBitrate||this._getBitrateByDefition(r.defaultDefinition),type:"default"}:n[n.length-1]),this.playerConfig.url=a.url,a.networkSpeed=se.Z.speed,a.fileSize=he.Z.getFileSize(a.bitrate,r.duration),t.curDefinition=a,a}},{key:"_setPlayerSrc",value:function(e){var t=this.player;this._removeVideoSource(),"Array"===te.Z.typeOf(e)?(t.video.removeAttribute("src"),!t._detachSourceEvents&&f()(e).call(e,(function(e){t.video.appendChild(te.Z.createDom("source","",{src:"".concat(e.src),type:"".concat(e.type||"")}))})),t._attachSourceEvents(t.video,e),t.play()):(t.video.src=e,t.play()),t.mp4MseFlag=!1,t.emit("playertypechange")}},{key:"_removeVideoSource",value:function(e){var t=this.player,i=(e=e||t.video).children;if(i.length>0)for(t._detachSourceEvents(e);i.length>0;)e.removeChild(i[0])}},{key:"_getBitrateByDefition",value:function(e){var t=this.playerConfig,i=0;if(!t.definition||!t.definition.list)return i;for(var r=0;r<t.definition.list.length;r++){var a=t.definition.list[r];a.definition===e&&(i=a.bitrate)}return i}},{key:"_getDefinitionItem",value:function(e){for(var t=this.playerConfig,i=0;i<t.definition.list.length;i++){var r=t.definition.list[i];if(r.definition===e)return r}return null}},{key:"_initAbrDefinition",value:function(){var e=this.player,t=this.playerConfig;if(t.definition.list.length>0&&(e.curDefinition||(e.curDefinition=t.definition.list[0]),e.curDefinition.vwidth||A()(e.curDefinition,this._getDefinitionItem(e.curDefinition.definition)),this._abrService.updateAbrCacheData()),this._abrService&&this._abrService.isCurrentAutoDefi){var i=t.definition.list.length;e.curDefinition=t.definition.list[i-1]}for(var r=0;r<t.definition.list.length;r++){var a=t.definition.list[r];e.curDefinition.definition===a.definition?a.selected=!0:a.selected=!1}this.player.emit("resourceReady",t.definition.list);var n=e.curDefinition.bitrate;if(!n)for(var s=0;s<t.definition.list.length;s++){var o=t.definition.list[s];o.definition===e.curDefinition.definition&&(n=o.bitrate)}this._abrService.updateBitrate(n)}},{key:"_initAbrService",value:(i=(0,G.Z)(ee().mark((function e(){var t,i;return ee().wrap((function(e){for(var r;;)switch(e.prev=e.next){case 0:if(t=this.playerConfig,(i=this.config).autoBitrateOpts&&i.autoBitrateOpts.isOpenAutoDefi){e.next=3;break}return e.abrupt("return");case 3:return this._abrService=new Ie(this,this.abrSwitchURL),e.next=6,this._abrService.init({video:S()(r=t.definition.list).call(r)});case 6:this._initAbrDefinition();case 7:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"_initMp4Kernel",value:function(){var e=this;this.firstFrameTime.newplayer_initkernel=he.Z.nowTime()-this.firstFrameTime.newplayer,this.log("[===========], initMp4Kernel,",he.Z.nowTime());var t=this.playerConfig,i=this.config,r=new ge.Z;if(this.codecType===Ve&&i.forceVideoPlay)return this.useVideoLoad=!0,r.reject("forceVideoPlay"),r;try{var a=this.getInitBitrate();if(this.log("[_initMp4Kernel] ".concat(t.vid," curDefinition"),a),!this._handlerUrl(t.url))return r.reject(new Error("emptyUrl")),r;var n=[];n.push(this._getLicense()),n.push(this._checkPreloader()),B().all(n).then((function(t){e.isDestroy&&r.reject(new Error("destroy"));var n=null;if(t&&t.length>0&&t[1]&&(n=t[1].data),!n&&i.needPreloadCheck&&e.codecType!==Ne)e.useVideoLoad=!0,r.reject(new Error("no_preload"));else if(e._vtype&&"MP3"===e._vtype)e.useVideoLoad=!0,r.reject(new Error("vtype_not_MP4"));else{var s=i._mainURL;e._initMp4(s,n,{fileSize:a.fileSize}),e._initAbrService()}})).catch((function(t){e.changeState("LICENSE_ERROR",{d:a.definition}),r.reject(t)}))}catch(s){r.reject(s)}return r}},{key:"playerStartInit",value:function(e){var t=this;if(!this.isDestroy)if(this.useVideoLoad)Oe.call(this.player,e);else{this.player.mp4MseFlag=!0,this.bufferEndTime=-1,this._tm=(new Date).getTime(),this._reset();var i=this.playerConfig.vid;this.preloader&&this.preloader.cancelPreloadByVid(i),this.changeState("PLAYER_START_INIT"),this._awPromise.then((function(){if(!t.isDestroy){t.changeState("AW_OK INIT_MP4_KERNEL");var r=t._initMp4Kernel();t._initPromise=r,t._addPendingPromise(t._initPromise),r.then((function(r){var a;t.isDestroy||(t.log(S()(a="[Index] _initMp4Kernel.then vid:".concat(i," isDestroy")).call(a,t.isDestroy),r,t.mse?t.mse.url:""),t.mse&&(e=t.mse.url),t.changeState("PLAY_INIT_OK"),t._bindEvents(),t._startProgress())})).catch((function(i){var r=!!t._initPromise&&t._initPromise.isBreak;if(!t.isDestroy&&!r)if(-499897!==i.errorCode){var a=i;a.errorCode||((a=new ie.ZP(t.player,{errorType:"runtime",errorTypeCode:1002,errorCode:Le.O1.other,vid:t.playerConfig.vid,errorMessage:i.message,mediaError:{code:Le.O1.other,message:i.message}})).url=e),t.changeState("PLAY_INIT_CATCH",{c:a.errorCode,m:a.message}),t.player.vtype="MP4_1",t.player.emit("playCatch","dash1mp4",a)}else t._emitExpireEvent(i)})).finally((function(){var i;if(t._initPromise){var r=t._initPromise.isBreak;t._initPromise&&t._removePendingPromise(t._initPromise),t._initPromise=null,t._usePaused&&(t.playerConfig.autoplay=!1),t.codecType===Ne&&"Array"===te.Z.typeOf(e)&&(e=e[0].src),t.log(S()(i="_initMp4Kernel.finally:isDestroy".concat(t.isDestroy," _initPromise.isBreak:")).call(i,r)),t.log("[===========], playerStartInit,",he.Z.nowTime()),t.changeState("PLAY_INIT_FINALLY"),!t.isDestroy&&!r&&Oe.call(t.player,e)}}))}})).catch((function(i){t.log("_awPromise.error",i),t.changeState("PLAY_INIT_CATCH"),!t.isDestroy&&Oe.call(t.player,e)})),this._abrService&&this._abrService.isCurrentInAbr()&&(this._abrService.enable(),this._abrService.execute())}}},{key:"playNext",value:function(e){var t=this.player;t.resetState(),this._useVideoLoad=!1,t.pause(),this._reset(),e.vtype&&(this._vtype=e.vtype.toUpperCase()),t.setConfig(e);var i=this.codecType;this.codecType=e.codecType?e.codecType.toLowerCase():Ve;var r=e[this.pluginName];r&&(this.config=A()(this.config,r)),i!==this.codecType&&this.h265_h264_switch(this.playerConfig.mediaType||"video"),this.checkConfig(),this.initAwManager(),this.log("[Index] playNext",e),t.play(),this.emit("logger_next")}},{key:"h265_h264_switch",value:function(e){this.log("h265_switch_h264");var t=this.player,i=te.Z.createDom(e,"",this.getVideoConfig(this.playerConfig),"xgplayer-".concat(e,"-img"));this.removeVideo=t.video,i.muted=t.video.muted,i.volume=t.video.volume,t.video=i,t.attachVideoEvents(t.video)}},{key:"getVideoConfig",value:function(e){var t=A()({},{controls:!1,autoplay:e.autoplay,playsinline:e.playsinline,"x5-playsinline":e.playsinline,"webkit-playsinline":e.playsinline,"x5-video-player-fullscreen":e["x5-video-player-fullscreen"]||e.x5VideoPlayerFullscreen,"x5-video-orientation":e["x5-video-orientation"]||e.x5VideoOrientation,airplay:e.airplay,"webkit-airplay":e.airplay,tabindex:2,mediaType:e.mediaType||"video"},e.videoConfig,e.videoAttributes);return e.loop&&(t.loop="loop"),t}},{key:"next",value:function(e){this.playNext(e)}},{key:"changeDefinition",value:function(e,t,i){var r=this;if(this.useVideoLoad)Ue.call(this.player,e,t);else{var a=this.player,n=this.playerConfig,s=this.mp4,o="\u81ea\u52a8"===e.definition||"auto"===e.definition;if(i)this.log("[ABR], ready to switch bitRate, ",e.bitrate);else{var d=!1;if(o)this._abrService&&this._abrService.enable(),d=!0;else if(this._abrService&&this._abrService.disable(),!e.bitrate||e.bitrate<=0)for(var u=0;u<n.definition.list.length;u++)e.definition===n.definition.list[u].definition&&(e.bitrate=n.definition.list[u].bitrate);a.emit(re.DEFINITION_CHANGE,{from:t,to:e}),b()((function(){r._abrService&&r._abrService.updateAutoDefiDesc(a.curDefinition.definition,!o)})),d&&(e=a.curDefinition),this.log("[ABR_cbs],switch bitRate, ",e.bitrate)}a.curDefinition=e;var h=a.definitionList,f=l()(h).call(h,(function(e){return e.definition===a.curDefinition.definition}));if(f.length>0&&(e=f[0]),this.config.keyValue=e.keyValue,s&&(s.kidValue=e.keyValue),n.url=e.url,n.backupURL=e.backupURL,s){var c=0,m=!1;if(this._abrService&&!this._abrService.isCurrentInAbr())c=a.currentTime,m=!0;else{var p=a.getBufferedRange(a.buffered2);c=p[1],this.log("[ABR],switch bufferRange, ",p)}var g=s.getFragmentIdx(c);g<0&&(g=this._curLoadSegmentIdx),this.log("[ABR],switch point,",g,",startTime,",s.timeRange[g].startTime),m&&a.emit("definitionSwitchTime",s.timeRange[g].startTime+1),s&&(s.MP4Loader&&s.MP4Loader.cancel(),s._loadingMoov&&(s._loadingMoov=!1));var y=a.getBufferedRange(a.buffered);!(y[1]>0&&y[1]-a.currentTime>5)||this._abrService&&this._abrService.isCurrentInAbr()||(this.mse.clearOpqueues(ne.wF.VIDEO),this.mse.reuse(a.currentTime+5,y[1])),s.resetFragmentLoadState(g),this._curLoadSegmentIdx=g,this.mp4&&this.mp4.changeBitRate(e);var v={width:e.width||e.vwidth,height:e.height||e.vheight};a.emit("RESOLUTION_UPDATE",v)}}}},{key:"switchURL",value:function(e){if(this.useVideoLoad)He.call(this.player,e);else{var t=this.player,i=this.playerConfig;this.config.keyValue=e.keyValue,i.url=e.url,i.backupURL=e.backupURL,t.currentTime=0,t.pause(),this.reset(),this._isMseInit=!1,this.eme=null,this._handlerUrl(e.url),t.video.removeAttribute("src"),this._removeVideoSource(),t.resetState()}}},{key:"_handlerUrl",value:function(e){var t,i=this.config,r=this.playerConfig;if(!e)return!1;var a=[];if("String"===te.Z.typeOf(e))t=e,r.backupURL&&a.push(r.backupURL);else if("Array"===te.Z.typeOf(e)&&e.length>0&&(t=e[0].src,e.length>1))for(var n=1;n<e.length;n++)a.push(he.Z.extUrl(e[n].src,{__vid:r.vid}));return!(!t&&0===a.length)&&(i._mainURL=he.Z.extUrl(t,{__vid:r.vid}),i._backupURL=a,!0)}},{key:"_firstFrameTime",value:function(){if(this.codecType===Ve){if(this.firstFrameTime.new_loadeddata<0){this.firstFrameTime.loadst_loadeddata=he.Z.nowTime()-this.loadstart,this.firstFrameTime.new_loadeddata=he.Z.nowTime()-this.firstFrameTime.newplayer;var e={};for(var t in this.firstFrameTime)Object.prototype.hasOwnProperty.call(this.firstFrameTime,t)&&(this.log("======this.firstFrameTime======",t,", ",this.firstFrameTime[t]),e[t]=this.firstFrameTime[t])}}else if(this.codecType===Ne){var i=this.player.video.getStats(),r=this.firstFrameTime.metaload,a=this.firstFrameTime.startMuxTime;this.firstFrameTime=i,this.firstFrameTime.metaload=r,this.firstFrameTime.startload_stmux=a,this.firstFrameTime.firstmux=this.mp4?this.mp4.firstFrameTime.firstmux:-1;for(var n=0;n<i.bootStats.length;n++)this.firstFrameTime[i.bootStats[n].action]=i.bootStats[n].dot;delete this.firstFrameTime.bootStats,this.log("======this.firstFrameTime===>>",O()(this.firstFrameTime))}}},{key:"_bindEvents",value:function(){var e=this,t=this.config;this._isEventInit||(this.on("seeking",this._onSeeking),this.on("waiting",this._onWaiting),this.on("ended",this._onEnded),this.on("playing",this._onPlaying),this.on("detectGap",(function(){t.gapDegrade&&t.useEME&&(t.useEME=!1,e._replay())}))),this._isEventInit=!0,this.once("playing",this._onMp4Init)}},{key:"deleteVideo",value:function(){if(this.removeVideo){var e=this.removeVideo.parentNode;e&&e.removeChild(this.removeVideo),this.removeVideo=null,this.log("[_removeVideoSource]")}}},{key:"_unbindEvents",value:function(){this.off("seeking",this._onSeeking),this.off("waiting",this._onWaiting),this.off("playing",this._onMp4Init),this.off("ended",this._onEnded),this.off("playing",this._onPlaying),this._isEventInit=!1}},{key:"changeState",value:function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this._pTime||(this._pTime=he.Z.nowTime());var i=he.Z.nowTime()-this._pTime,r=he.Z.nowTime()-this._sTime;this.log(">>>changeState[".concat(e,"]"),i,r,t),this.states.push({state:e,t1:i,t2:r,data:t}),this._pTime=he.Z.nowTime();var a=he.Z.nowTime()-this._pTime;t.state=e,a&&(t.t=a)}},{key:"checkIfCanPreload",value:function(){var e=this.player,t=this.useVideoLoad,i=this.config;if(i.isOpenPreload){var r=t?5:i.minBufferLength,a=e.currentTime+r;a=a>e.duration?e.duration:a;var n=(t?e.getBufferedRange(e.buffered):e.getBufferedRange(e.buffered2))[1]-a;e.currentTime>=r&&(n>0||Math.abs(n)<1)&&this.preloader&&this.preloader.checkCanPreloadNext()&&this.emit("PRELOAD_NEXT")}}},{key:"_getLicense",value:function(){var e=this,t=this.config,i=t.vid,r=t.kid,a=t.secretKey,n=new ge.Z,s={method:"getLicense",success:0};if(r||a){var o=(0,fe.sF)(i,r,a,this);o.id="licensePromise",this._addPendingPromise(o),o.then((function(t){e._removePendingPromise(o),t.clearKeys?e.config.drm=t:e.config.keyValue=t,s.success=1,n.resolve(s)})).catch((function(t){throw e.log("licensePromise reject"),s.success=0,s.error=t,n.reject(s),t}))}else s.success=0,n.resolve(s);return n}},{key:"softDecode",get:function(){var e,t;return"xg-video"===(null===(e=this.player)||void 0===e||null===(t=e.config)||void 0===t?void 0:t.mediaType)}},{key:"_initH265MseProxy",value:function(){this.player.video instanceof HTMLVideoElement&&this.h265_h264_switch(this.playerConfig.mediaType);var e=this.player.video;this.softDecode&&e.setPlayMode&&e.setPlayMode("VOD"),this.mseProxy=e,this.softDecode&&(this.player.forceDegradeToVideo=function(){},this.player.video.addEventListener("lowdecode",this._lowDecoder),this.player.video.addEventListener("error",this._onError))}},{key:"_initMp4",value:function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};this.firstFrameTime.initkernel_initmp4=he.Z.nowTime()-this.firstFrameTime.newplayer-this.firstFrameTime.newplayer_initkernel;var r=this.config,a=this.player,n=this.playerConfig;this.mp4&&(this.mp4.off("metaReady",this._onMp4MetaReady),this.mp4.off("error",this._onMp4Error),this.mp4.off(se.k.TASK_PROGRESS,this._onMp4Progress),this.mp4.off(se.k.MOOV_REQ_PROGRESS,this._onMp4DataCallBack),this.mp4.destroy(),this.mp4=null),this.changeState("MP4_NEW",{}),this.mp4=new se.Z(e,a.curDefinition.bitrate,{segmentDuration:r.segmentMinDuration,enableWorker:r.enableWorker,codecType:this.codecType,chunkSize:r.preloadSize,duration:n.duration||0,fileSize:i.fileSize||0,playerId:this.playerId,vid:n.vid,useUrlRange:r.useUrlRange,retryCount:r.retryCount,retryDelay:r.retryDelay},this,null,t,this.config._backupURL,this.firstFrameTime,""),this.mp4.once("metaReady",this._onMp4MetaReady),this.mp4.on("error",this._onMp4Error),this.mp4.on(se.k.TASK_PROGRESS,this._onMp4Progress),this.mp4.on(se.k.MOOV_REQ_PROGRESS,this._onMp4DataCallBack),this.changeState("MP4_INIT",{}),this.mp4.init(t)}},{key:"_checkPreloader",value:function(){var e=this,t=this.playerConfig,i=new ge.Z,r={method:"checkPreloader",success:0,type:"error",cacheKey:""};this.changeState("CHECK_PRELOAD");var a=this.player.curDefinition,n=a.cacheKey?a.cacheKey:Te.ZP.generateUniqueKey({vid:t.vid,definition:a.definition||"",vtype:t.vtype,codecType:t.codecType});return r.cacheKey=n,this.preloader&&n?this.preloader.getPreLoadData(n).then((function(t){t?(e.preLoadData=t,e.emit("PRELOAD_INFO",e.preLoadData),r.success=1,r.data=t,e.changeState("PRELOAD_OK",{l:e.preLoadData.byteLength,ck:n}),t.mediaSegList&&t.mediaSegList.length>0||t.buffer&&t.buffer.byteLength>0?e.hitpreload=!0:e.hitpreload=!1,i.resolve(r)):(e.preLoadData=null,e.changeState("PRELOAD_ERROR",{t:0}),r.success=0,r.error=new Error("none_preload"),i.resolve(r))})):(this.changeState("PRELOAD_ERROR",{t:2}),r.success=0,r.error=new Error("no_preloader"),i.resolve(r)),i}},{key:"_initEME",value:function(e,t){var i=this.player,r=this.config,n=e.checkCodecH265();r.useEME=!(!1===r.useEME||n),t.kid&&r.keyValue?r.drm={clearKeys:(0,X.Z)({},t.kid,r.keyValue)}:!t.kid&&r.keyValue&&(r.useEME=!1);var s=r.drm;s&&s.clearKeys&&(r.useEME&&(this.eme=new ce(s)),this.log("config.useEME: ",r.useEME),e.useEME=r.useEME,e.useEME||(e.kidValue=s.clearKeys[a()(s.clearKeys)[0]])),!r.keyValue&&!s||r.useEME||e.kidValue||(e.kidValue=r.keyValue||s),r.useEME&&this.eme&&(this.eme.setOptions('video/mp4; codecs="avc1.64001E"','audio/mp4; codecs="mp4a.40.2"'),this.eme.SetupEME(i.video))}},{key:"_initMse",value:function(){var e,t=this,i=this.playerConfig;this.mse&&(this.mse.destroy(),this.mse=null);var r=(0,X.Z)({},ne.wF.VIDEO,{mimeType:"video/mp4",codec:'video/mp4; codecs="avc1.64001E, mp4a.40.5"'});this.mse=new ne.ZP(i.mediaType,w()(e=this.log).call(e,this)),this.mse.on(ne.YJ.MSE_OPEN,(function(e){t.firstFrameTime.initmse_sbopen=e.costtime,t._loadStartEventTime>0&&(t.firstFrameTime.mseopen=he.Z.nowTime()-t._loadStartEventTime),t.changeState("MSE_OPEN")})),this.mse.on(ne.YJ.MSE_OPEN_DONE,(function(e){t.firstFrameTime.initmse_sbopendone=e.costtime,t.changeState("MSE_OPEN_DONE"),t._isMseInit=!0,t._onTimeUpdate()})),this.mse.on(ne.YJ.MSE_ERROR,(function(e){var r=new ie.ZP(t.player,{errorType:"runtime",errorTypeCode:1002,errorCode:Le.O1.mseAppend,errorMessage:e.message,vid:i.vid,mediaError:{code:Le.O1.mseAppend,message:e.message}});t._errorHandler(r)})),this.mse.on(ne.YJ.UPDATE_END,(function(e){var i=e.context,r=e.costtime;if(i&&i.isinit)t.firstFrameTime.metaready_initsegend=r,t.log("player appendBuffer end ==>>>",i||null,", costTime,",r),t.changeState("MSE_INITSEG_OK");else if(t.log("player appendBuffer end ==>>>",i||null,", costTime,",r,", opt,",e.name,",bufferRange,",t.player.getBufferedRange()),t.firstFrameTime.loadst_loadeddata<0&&(t._firstSegState<0&&t._onTimeUpdate(),t.firstFrameTime.apcnt++,t.firstFrameTime.aplen+=i?i.dataLen:0,t.firstFrameTime.data_ap+=r,t.changeState("APPEND_DATA_OK",{costime:r,dataLen:i?i.dataLen:0})),t.mse&&i.state&&i.fragIndex===t.mp4.timeRange.length-1){var a=t.player.buffered;t.bufferEndTime=a.end(a.length-1),t._isEnded(),t.log("loaded ended !!!==>>>",i.range,", fragIndex,",i.fragIndex,", bufferEndTime,",t.bufferEndTime,",meta_duration,",t.mp4.meta.duration)}})),this.changeState("MSE_INIT"),this.mse.init(r)}},{key:"_appendInitSeg",value:function(e){if(this.mp4&&this.mse){var t=this.mp4.meta,i=this.mp4.checkCodecH265(),r=!!t.videoCodec,a=!!t.audioCodec;if(!i&&a&&r)this.changeState("MSE_INITSEG"),this.log("[=======ready_append_init]",he.Z.nowTime(),",mseDone,",!!this.mse&&this.mse._mseAppendFlag,",isopen,",!!this.mse&&this.mse.isMediaSourceOpen()),!this.mse._mseAppendFlag&&this.openMSE(),this.firstFrameTime.metaready_mseisopen=this.mse&&this.mse._mseAppendFlag?1:0,this.mse.appendBuffer(ne.wF.VIDEO,e,{vid:this.playerConfig.vid,range:null,dataLen:e.byteLength,isinit:!0}),this.mp4.useEME&&this.eme&&this.eme.emit("encrypted");else{this.firstFrameTime.vailcodec=this.config._mainURL;var n=new ie.ZP(this.player,{errorType:"runtime",errorTypeCode:1002,errorCode:Le.O1.mse,vid:this.playerConfig.vid,errorMessage:"codec_not_match",mediaError:{code:Le.O1.mse,message:"codec_not_match"}});this._errorHandler(n)}}}},{key:"_checkMetaInfo",value:function(e){var t=null;return e?null:(t={errorCode:Le.O1.metaError,errorMessage:"meta is null",errorType:"demux",errorTypeCode:1006},new ie.ZP(this.player,Ze(Ze({},t),{},{vid:this.playerConfig.vid,mediaError:{code:t.errorCode,message:t.errorMessage}})))}},{key:"_stopProgress",value:function(){this._hasStartProgress=!1,this._requestTimer&&(this._requestTimer.stop(),this._requestTimer=null),this._bufferBreakTimer&&(clearTimeout(this._bufferBreakTimer),this._bufferBreakTimer=null,this._bufferBreakFlag=undefined)}},{key:"_bindNetworkStateChange",value:function(){window.addEventListener("online",this._onOnlineHandler),window.addEventListener("offline",this._onOfflineHandler)}},{key:"_unbindNetworkStateChange",value:function(){window.removeEventListener("online",this._onOnlineHandler),window.removeEventListener("offline",this._onOfflineHandler)}},{key:"_onSuperStart",value:function(e){var t=this,i=this.player;(0,be.cM)("_onSuperStart:".concat(e),this.mse),i.video.src=e,this.once("canplay",(function(){i.play(),t.on("waiting",t._onWaiting)}))}},{key:"openMSE",value:function(){var e=this.mse;!e._mseAppendFlag&&e.isMediaSourceOpen()&&(this.log("[=======\u4e3b\u52a8\u8c03\u7528_onSourceOpen start]",he.Z.nowTime()),e._onSourceOpen(),this.log("[=======\u4e3b\u52a8\u8c03\u7528_onSourceOpen, end ]",he.Z.nowTime(),"mseDone,",e._mseAppendFlag))}},{key:"_appendBuffer",value:function(e,t){var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},r=arguments.length>3?arguments[3]:undefined,a=this.mse,n=this.playerConfig,s=n.vid;this.log("player appendBuffer start ==>>>",s,i.range,t.byteLength,", queueLen,",a&&a.opQueues[e]?a.opQueues[e].length:null),a._mseAppendFlag||(this.openMSE(),this.firstFrameTime.metaready_mseisopen=this.mse&&this.mse._mseAppendFlag?2:-1),a.appendBuffer(e,t,{vid:s,fragIndex:i.fragIndex,range:i.range,dataLen:t.byteLength,state:r})}},{key:"_loadData",value:(t=(0,G.Z)(ee().mark((function e(){return ee().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(navigator.onLine){e.next=2;break}return e.abrupt("return");case 2:if(this.mp4&&this._isMseInit){e.next=5;break}return this.log("loadData, player.mp4 null",this._isMseInit),e.abrupt("return");case 5:return this.loadstart<0&&(this.loadstart=he.Z.nowTime()),e.prev=6,e.next=9,this.mp4.load(this._curLoadSegmentIdx,this._loadDataSuccess,this._loadDataFail);case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(6);case 14:case"end":return e.stop()}}),e,this,[[6,11]])}))),function(){return t.apply(this,arguments)})},{key:"getDataBitRate",value:function(e){var t=this.mp4,i=this.playerConfig;if(!t)return 0;for(var r=t.getDataBitRate(e),a=i.definition.list,n=0,s=0;s<a.length;s++)if(a[s].bitrate===r){n=a[s];break}return n}},{key:"_loadStuckCheck",value:function(){var e=this,t=this.config,i=this.playerConfig,r=this.player;t.disableBufferBreakCheck||(r.currentTime-(this._lastCurrentTime||0)>.1||r.paused?1!==this._bufferBreakFlag&&2!==this._bufferBreakFlag||(this.log("\u89c6\u9891\u6ca1\u6709\u5361\u6b7b,\u91cd\u7f6e\u5361\u6b7b\u6807\u8bb0"),this._bufferBreakFlag=0,clearTimeout(this._bufferBreakTimer),this._bufferBreakFlag=null):this._bufferBreakFlag||(this._bufferBreakFlag=1,this.log("\u5361\u6b7b\u8ba1\u65f6\u5f00\u59cb! \u6301\u7eed".concat(1e4,"\u6beb\u79d2\u5219\u786e\u8ba4\u5361\u6b7b")),this._bufferBreakTimer=b()((function(){e.isDestroy||(1===e._bufferBreakFlag&&(e._bufferBreakFlag=2,e.log("\u786e\u8ba4\u5361\u6b7b!!!"),e._errorHandler(new ie.ZP(e.player,{errorType:"runtime",errorTypeCode:1002,errorCode:Le.O1.waitTimeout,errorMessage:"wait_timeout",vid:i.vid,mediaError:{code:Le.O1.waitTimeout}}))),e._bufferBreakTimer=null)}),1e4)),this._lastCurrentTime=r.currentTime)}},{key:"_onTimeUpdate",value:function(){var e=this,t=this.mse,i=this.mp4,r=this.player;if(this.useVideoLoad)this.checkIfCanPreload();else if(i&&i.timeRange&&!(i.timeRange.length<1)&&1!==this._firstSegState&&(t||this.mseProxy)&&i&&i.canDownload){he.Z.nowTime()-this._lastCheckTime>1e3&&(this._lastCheckTime=he.Z.nowTime(),this._loadStuckCheck(),this._startUrlExpiredCheck());var a=i.timeRange,n=r.getBufferedRange(r.buffered2);this._checkRemoveSourceBuffer(n,r.currentTime);var s=r.paused?r.currentTime+this._maxPausedBufferLength:r.currentTime+this._maxBufferLength;n[1]-s<0&&R()(a).call(a,(function(t,i){if(t.downloaded)return!0;t.startTime-r.currentTime<e._maxBufferLength?(e._curLoadSegmentIdx=i,e.log("[onTimeUpdate],load index==>>>, ",i,",IdxTimeRange, ",t.startTime,"-",t.endTime,",buffEnd, ",n[1],",playCurTime,",r.currentTime,", bufferLen,",n[1]-r.currentTime,",bufferRangeList,",e.player.buffered2.bufferedList),e._loadData()):e.log("[onTimeUpdate] not load index==>>>",i,",IdxTimeRange, ",t.startTime,"-",t.endTime,",playCurTime,",r.currentTime,",bufferRangeList,",e.player.buffered2.bufferedList)})),this.checkIfCanPreload(),this.playFlag&&!this._hasTriggerBufferThreshold&&this._startBufferCheck(),this._isEnded()}}},{key:"_reset",value:function(){for(var e in this.states=[],this.hitpreload=!1,this._sTime=he.Z.nowTime(),this._usePaused=!1,this._firstSegState=-1,this.useVideoLoad=!1,this._isMseInit=!1,this.endofstream=!1,this._curLoadSegmentIdx=0,this.preLoadData=null,this.forPreloadTimeCache=null,this.playFlag=!1,this._waitAdjustTimeCnt=0,this._initPromise&&"pending"===this._initPromise.state&&this._initPromise.reject("DESTROYED"),clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=null,this._stopProgress(),this.mp4&&(this.mp4.off("metaReady",this._onMp4MetaReady),this.mp4.off("error",this._onMp4Error),this.mp4.off(se.k.TASK_PROGRESS,this._onMp4Progress),this.mp4.off(se.k.MOOV_REQ_PROGRESS,this._onMp4DataCallBack),this.mp4.destroy(),this.mp4=null),this.mse&&(this.mse.destroy(),this.mse=null),this.mseProxy&&(this.player.video.removeEventListener("lowdecode",this._onDegrade),this.player.video.removeEventListener("error",this._onError)),this._clearMediaKeys(),this._unloadVideo(),this._cancelPendingPromises(),this._abrService&&(this._abrService.destroy(),this._abrService=null),this.firstFrameTime)Object.prototype.hasOwnProperty.call(this.firstFrameTime,e)&&(this.firstFrameTime[e]="apcnt"===e||"aplen"===e?0:"newplayer"===e?he.Z.nowTime():-1);clearTimeout(this._waitInBufferTimer),this._waitInBufferTimer=null,this.loadstart=-1,this._loadStartEventTime=-1,this.startLoadData=-1}},{key:"removeErrorUrls",value:function(e,t,i){return-499897!==e.errorCode&&-499892!==e.errorCode||this._emitExpireEvent(e),i}},{key:"_errorHandler",value:function(e){var t=this.player,i=this.playerConfig,r=this.preLoadData;if(t)if(this.useVideoLoad)this.emit("error",e);else{if("object"!==(0,W.Z)(e)){var a={};a.err=e,e=a}var n=t.paused;e.vid=i.vid,e.preloadHit=r&&r.byteLength>0?1:0,e.preloadCached=r?r.duration:0,e=new ie.ZP(t,e),this.log("_errorHandle","preState is ".concat(n),e),!e.url&&(e.url=t.src),this.player.vtype="MP4_2",this.player.emit("playCatch","dash2mp4",e),e.errd&&"object"===(0,W.Z)(e.errd)&&this.mp4&&(e.errd.url=this.mp4.url,e.url=this.mp4.url),e.codectype=this.codecType,this.emit("DATA_REPORT",e),this.mp4&&this.mp4.url&&this.removeErrorUrls(e,this.mp4.url,i.url),this.log("error task cancel"),this.mp4&&this.mp4.MP4Loader&&this.mp4.MP4Loader.cancel(),this._abrService&&this._abrService.disable(),this.mp4&&(this.mp4.canDownload=!1),this.mp4&&this.mp4.bufferCache&&this.mp4.bufferCache.clear(),this.player.emit("playCatch","dash2mp4",e),this._startDegradedPlayback(e)}}},{key:"_startDegradedPlayback",value:function(e){var t=this;this.mp4&&(this.mp4.canDownload=!1);var i=this.player,r=this.playerConfig;if(this.endofstream=!1,i.currentTime&&(this._currentTime=i.currentTime),this.player.pause(),this._reset(),this._replay=null,this.codecType===Ne)if("Array"===te.Z.typeOf(r.url)&&r.url.length>0){var n={url:r.url,codecType:this.codecType,vtype:this._vtype};this.player.playNext(n),this.player.currentTime=this._currentTime}else this._onDegrade(e);else if(this.codecType===Ve)if(this.config.drm){var s;if(this.config.drm)I()(s=a()(this.config.drm)).call(s,(function(i){t.config.drm&&(e[i]=t.config.drm[i])}));this.emit("error",e)}else this.useVideoLoad=!0,this._setPlayerSrc(r.url),this.once("canplay",(function(){t._currentTime&&(i.currentTime=t._currentTime),!i.paused&&i.play()}))}},{key:"_startProgress",value:function(){var e=this;this._hasStartProgress||(this._stopProgress(),this._requestTimer=new _e.Z((function(){e._requestTimer&&e._onTimeUpdate()})),this._requestTimer.tickEvery(this._tickInSeconds),this._hasStartProgress=!0)}},{key:"_unloadVideo",value:function(){var e=this.player;try{this.log("unloadVideo src ".concat(e.video.src)),e.video&&e.video.src&&(e.video.removeAttribute("src"),e.video.load())}catch(t){this.log("unloadVideo error",t)}}},{key:"_addPendingPromise",value:function(e){this._pendingPromises.push(e)}},{key:"_removePendingPromise",value:function(e){var t;this.log("removePendingPromise",e.id);var i,r=x()(t=this._pendingPromises).call(t,e);r>-1&&H()(i=this._pendingPromises).call(i,r,1)}},{key:"_cancelPendingPromises",value:function(){var e;this._pendingPromises.length>0&&f()(e=this._pendingPromises).call(e,(function(e){e.reject("DESTROYED")}));this._pendingPromises=[]}},{key:"_onMediaExpired",value:function(){this._stopProgress(),this.emit(ke.MEDIA_EXPIRED)}},{key:"_onDestroyWasm",value:function(){this.awManager&&(this.awManager.destroy(),this.awManager=null)}},{key:"_isEnded",value:function(){var e=this.player,t=this.mp4,i=e.bufferedPoint,r=i?i.end:0;return!this.endofstream&&this.bufferEndTime>0&&this.mse&&this.bufferEndTime-e.currentTime<.5&&(this.log("[check player isEnded],deal mse.endOfStream, currentTime,",e.currentTime,", bufferend,",r,", duration,",t.meta.duration),this.endofstream=!0,this.mse.endOfStream()),!!(t&&t.meta&&t.meta.duration-e.currentTime<.5)&&(this._stopProgress(),this.log("[check player isEnded],stopProgress and endOfStream,currentTime, ",e.currentTime,", bufferend,",r,", duration,",t.meta.duration),this.mse&&this.mse.endOfStream(),!0)}},{key:"_clearMediaKeys",value:function(){var e=this.player;"function"==typeof e.video.setMediaKeys&&e.video.setMediaKeys(null).catch((function(){}))}},{key:"_checkRemoveSourceBuffer",value:function(e,t){if(!(he.Z.nowTime()-this._checkRemoveBufferLastTime<=3e4||this.endofstream)&&(this._checkRemoveBufferLastTime=he.Z.nowTime(),this.mse&&this.mp4&&e&&e[0]>=0&&t-e[0]>this.config.removeBufferLen)){var i=this.mp4.getFragmentIdx(t-15);if(i>0){var r=Math.floor(Math.min(this.mp4.timeRange[i].startTime,e[1]));this.log("[removeSourceBuffer], range==>>>",e[0],r),this.mse.reuse(e[0],r)}}}},{key:"onMediaUpdate",value:function(e){var t=e.vid,i=e.kid,r=e.url,a=this.player,n=this.config;if(t===this.playerConfig.vid&&i===n.kid&&r){this.playerConfig.url=r,this._handlerUrl(r);var s=n._mainURL;return this.useVideoLoad?a.src=r:this.mp4&&this.mp4.update(s),!0}return!1}},{key:"enableAutoBuffer",value:function(e){var t=this;if(e){if(!this._allInitPromise)return void this.log("player destroyed!!");this._allInitPromise.then((function(){t.log("enableAutoBuffer true"),t._startProgress()}))}else this._stopProgress(),this.log("enableAutoBuffer false")}},{key:"bitRateAdapter",get:function(){return this.player&&this.player.plugins&&this.config.needAutoBitrate?this.player.plugins.bitrateselector:null}},{key:"getDefinitonFromAdapter",value:function(e,t){if(!this.bitRateAdapter)return null;var i=this.bitRateAdapter;return i.getSuitableBitrate?i.getSuitableBitrate(e,t):i.bitRateAdapter?i.bitRateAdapter.select(e):null}},{key:"addPreloader",value:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};e.playerId=this.playerId,this.preloader?this.preloader.addPreloader(e,this.playerId,this.playerConfig.vid):this.log("preloader has destroyed")}},{key:"addPreloaderList",value:function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];this.preloader?this.preloader.addPreloaderList(e,this.playerId,this.playerConfig.vid):this.log("preloader has destroyed")}},{key:"changeUserSelectDefinition",value:function(e){this.preloader&&e&&this.preloader.changeUserSelectDefinition(e)}},{key:"log",value:function(e){for(var t,i,r=this.playerConfig,a=r&&r.vid?S()(t="[Index]".concat(r.vid," ")).call(t,e):"[Index] ".concat(e),n=arguments.length,s=new Array(n>1?n-1:0),o=1;o<n;o++)s[o-1]=arguments[o];be.cM.apply(void 0,S()(i=[a]).call(i,s))}},{key:"_emitInitFail",value:function(e){this.log("initFail, reason:",e),this.emit(ke.INIT_FAIL,e)}},{key:"emitParseError",value:function(){this.log("parseError"),this.emit(ke.PARSE_ERROR)}},{key:"useVideoLoad",get:function(){return this._useVideoLoad},set:function(e){this._useVideoLoad=e}},{key:"ready",get:function(){return this._allInitPromise}},{key:"speed",get:function(){return N()(se.Z.speed,10)}},{key:"version",get:function(){return xe.Z}},{key:"realTimeSpeed",get:function(){return N()(se.Z.realTimeSpeed,10)}},{key:"opQueueLen",get:function(){var e=this.mse&&this.mse.opQueues?this.mse.opQueues.video:[];return e?e.length:0}},{key:"loadSegmentTimeRange",get:function(){if(!this.mp4)return[0,0,0,0];var e=this.mp4.timeRange;if(e&&e.length>0&&this._curLoadSegmentIdx&&this._curLoadSegmentIdx<e.length){var t=e[this._curLoadSegmentIdx];if(t.isLoading){var i,r=this.mp4.getFragRange(this._curLoadSegmentIdx);return S()(i=[Number(t.startTime),Number(t.endTime)]).call(i,(0,K.Z)(r))}}return[0,0,0,0]}},{key:"preloadState",get:function(){return this.preloader&&this.preloader.loadingCount}},{key:"moovSize",get:function(){return 0}},{key:"isDestroy",get:function(){return!this.player}},{key:"cancelPreloadTask",value:function(){this.preloader&&this.preloader.cancelLoading(this.player.playerId)}},{key:"CDNUrl",get:function(){var e=this.config.url,t=document.createElement("a");return t.href=e,t.host}},{key:"_handleUrlExpire",value:function(){var e=this,t=this.config,i=this.player,r=i.paused;(new Date).getTime()/1e3>=this.urlExpireTimestamp&&this.urlExpireTimestamp>0&&!r&&t.getServerTime&&(i.serverTimeDiffPromise=i.serverTimeDiffPromise||t.getServerTime().catch((function(){return 0})),i.serverTimeDiffPromise.then((function(t){if(t&&(i.serverTimeDiff=(new Date).getTime()/1e3-t),(new Date).getTime()/1e3>=e.urlExpireTimestamp+i.serverTimeDiff){e.urlExpireTimestamp=(new Date).getTime()/1e3+86400;var r=new Le.oO("network",Le.O1[403]);e._emitExpireEvent(r)}})))}},{key:"_emitExpireEvent",value:function(e){var t=this.player,i=(new Date).getTime()/1e3;this.emitExpireTimestamp?i-this.emitExpireTimestamp>300&&(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e)):(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e))}}],[{key:"registerPreloader",value:function(e,t){e.vtype=Ce.l0.MP4,Te.ZP.BitRateAdapter=t,new Te.ZP(e,this)}},{key:"pluginName",get:function(){return"Mp4EncryptPlayer"}},{key:"defaultConfig",get:function(){return{onlyInit:!1,useWaterLevel:!1,maxBufferLength:10,maxPausedBufferLength:5,minBufferLength:5,tickInSeconds:.2,getLicenseUrl:"",xhrSetup:{},preloadSize:1024e3,retryCount:1,retryDelay:1e3,preloadCacheType:1,mp4Init:!1,needPreloadRangeList:!1,cdnHost:"",cdnBucket:"",isEncrypt:!1,isOpenPreload:!0,needPreloadCheck:!1,preloadTime:0,preloadMaxCacheCount:0,needAutoBitrate:!0,keyValue:null,drm:null,enableWorker:!1,bufferThreshold:10,removeBufferLen:40,focusUserDefinition:!1,resumePlayWaterLevel:2,waitJampBufferMaxCnt:3,waitingInBufferTimeOut:5e3,h265Degrade:!1,forceVideoPlay:!1,segmentMinDuration:2}}},{key:"speed",get:function(){return se.Z.speed}},{key:"realTimeSpeed",get:function(){return se.Z.realTimeSpeed}},{key:"version",get:function(){return xe.Z}}]),n}(ae.ZP);Ke.isSupported=ve.Gb,Ke.isEMESupported=ve.KI,Ke.isSupportedWithXgmse=ve.pU,Ke.isMediaSourceSupported=ve.Hs,Ke.isWebAssemblySupported=ve.qK,Ke.getPlayLicenses=fe.Uy,Ke.CUSTOM_EVENTS=ke},10237:function(e,t,i){i.d(t,{T:function(){return a}});i(54414);var r=[{range:[0,90],size:1024e3},{range:[90,120],size:1536e3},{range:[120,Number.MAX_VALUE],size:2048e3}];function a(e,t,i){var a=i>51200?Math.min(i,t):t;if(!e)return a;for(var n=0;n<r.length;n++)if(e>=r[n].range[0]&&e<r[n].range[1]){a=i>51200?Math.min(Math.max(a,r[n].size),i):t;break}return a}},45118:function(e,t,i){i.d(t,{k:function(){return ee},Z:function(){return te}});var r=i(97448),a=i.n(r),n=i(44540),s=i.n(n),o=i(63862),l=i.n(o),d=i(66581),u=i.n(d),h=i(90400),f=i.n(h),c=i(33743),m=i.n(c),p=i(12067),g=i.n(p),y=i(84713),v=i.n(y),_=i(18556),T=i.n(_),k=i(23947),b=i.n(k),E=i(24514),S=i.n(E),P=i(54882),R=i.n(P),L=i(11235),x=i.n(L),M=i(57276),w=i.n(M),D=i(38574),I=i.n(D),C=(i(22032),i(60892),i(15243),i(20145),i(48168),i(86499),i(61396),i(86632),i(11757),i(47338),i(47976),i(58200)),A=i(94978),Z=i(12922),B=i(53560),F=(i(67846),i(72831),i(8356),i(86919),i(83867),i(21592),i(26592),i(10954),i(8340),i(37920),i(86240),i(78344),i(2517),i(3244),i(60208),i(9368),i(60968),i(43146),i(55507),i(53511),i(68976),i(85653),i(80034),i(29928),i(23914),i(9190),i(71198),i(47146),i(42755),i(2259),i(7195),i(92676),i(32543),i(50232),i(14652),i(86267),i(18839),i(46603),i(54414),i(75645),i(5304),i(91609)),O=i.n(F),U=i(14402),H=i.n(U),V=i(44699),N=i.n(V),K=i(28808),W=i(44211),G=i(81318),j=i(25726),q=i(28310),Y=i(90934),z=i(82612),J=i(10237),Q=i(42249);function X(e,t){var i=a()(e);if(s()){var r=s()(e);t&&(r=l()(r).call(r,(function(t){return u()(e,t).enumerable}))),i.push.apply(i,r)}return i}function $(e){for(var t=1;t<arguments.length;t++){var i,r,a=null!=arguments[t]?arguments[t]:{};t%2?f()(i=X(Object(a),!0)).call(i,(function(t){(0,B.Z)(e,t,a[t])})):m()?g()(e,m()(a)):f()(r=X(Object(a))).call(r,(function(t){v()(e,t,u()(a,t))}))}return e}var ee={ERROR:"error",META_READY:"metaReady",MOOV_READY:"moovReady",MOOV_REQ_PROGRESS:"moov_request_Progress",TASK_PROGRESS:"progress_event",REMOVE_URL:"remove_url",FRAGMENT:"fragment"},te=function(){function e(t,i,r,n){var s,o=this,l=arguments.length>6&&arguments[6]!==undefined?arguments[6]:[],d=arguments.length>7?arguments[7]:undefined,u=arguments.length>8?arguments[8]:undefined;if((0,A.Z)(this,e),(0,B.Z)(this,"onprogressDataArrive",function(){var e=(0,C.Z)(O().mark((function e(t,i,r){var a;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r&&r.err&&(o.log("[mp4.loadFragment onprogressDataArrive error],fragmentIdx,",r.index,",range,",r.range,", err,",r.err),o.errorHandler(r.err,i,r)),t&&t.byteLength>0&&((a=o.timeRange[r.index].range)&&r.range[1]>=a[1]&&!i&&(i=!0),o.log("[mp4.loadFragment onprogressDataArrive ] receive data, >>> index,",r.index,",range,",r.range,", dataLen,",t.byteLength),o._mux(t,r.range[0],r.index,i)),i&&(o.timeRange[r.index].downloaded=!0,o.bufferLoadedPos=-1,o.log("[FragLoadDowned],fragmentIdx,",r.index,",rangeEnd,",r.range[1]));case 3:case"end":return e.stop()}}),e)})));return function(t,i,r){return e.apply(this,arguments)}}()),H()(this),this.timeRecord={startMuxTime:-1,startLoadTime:-1,newMP4Time:j.Z.nowTime(),startLoadMetaTime:-1},this.url=t,this.backUrl=l||[],this._bitRate=i,this.options=e.getDefaultConfig(),T()(s=a()(r)).call(s,(function(e){r[e]!==undefined&&null!==r[e]&&(o.options[e]=r[e])})),this.timeRange=[],this.firstFrameTime=d||{},this._logTag=u||"",this.CHUNK_SIZE=(0,J.T)(r.duration,this.options.chunkSize,r.fileSize),this.player=n,this.bufferLoaded=new Uint8Array(0),this.bufferLoadedPos=0,this.meta=null,this.preloadCache=null,this.videoTrak=null,this.audioTrak=null,this.canDownload=!0,this._loadSuccessCallBack=null,this._loadErrCallBack=null,this._isPending=!1,this._metaLoading=!1,this.MP4Loader=new q.b({segmentDuration:r.segmentDuration,url:t,vid:r.vid+"-"+i,retry:r.retryCount||2,retryDelay:r.retryDelay||1e3,timeout:3e3,openLog:(0,Y.qw)()}),this._needInitSegment=!0,this._bitRateInfoMap=new(b()),this._switchBitRate=!1,this._segmentToBitRateMap=new(b()),this._seekIdxWhenLoadingMoov=-1,this.useEME=!1,this.kidValue=null,this.enableWorker=r.enableWorker&&"h265"!==r.codecType,this.enableWorker&&"undefined"!=typeof Worker)try{this.workerSequence=0,this.transmuxerWorkerControl=new Q.Z({id:this.workerSequence,codecType:r.codecType,openLog:(0,Y.qw)()}),this.eventListen=!1}catch(h){this.log("Error in worker:",h),this.enableWorker=!1,this.transmuxerWorkerControl=null}this.enableWorker||(this.MP4Demuxer=null,this.FMP4Remuxer=null),this.seekTime=-1}var t,i,r,n,s,o,d,u;return(0,Z.Z)(e,[{key:"changeBitRate",value:(u=(0,C.Z)(O().mark((function e(t){return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.bitrate===this._bitRate){e.next=7;break}return this.url=t.url,this._bitRate=t.bitrate,this.backUrl=t.backupURL,this._switchBitRate=!0,e.next=7,this.MP4Loader.changeUrl(this.url,this.options.vid+"-"+this._bitRate,this.CHUNK_SIZE);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"_getByPreload",value:function(e,t,i,r){try{if(e&&e.byteLength>=t){var a={endTime:(new Date).getTime(),startTime:(new Date).getTime(),index:r,range:[],vid:this.options.vid,from:"local"};if(i<=e.byteLength){var n=S()(e).call(e,t,i);return a.range=[t,i],a.state=!0,{buffer:n,context:a,state:!0}}var s=e.byteLength-1,o=S()(e).call(e,t,s);return a.range=[t,s],{context:a,buffer:o,state:!1}}return null}catch(l){return null}}},{key:"log",value:function(e){for(var t,i,r,a,n=this.options,s=n&&n.vid?R()(t=R()(i="[MP4]".concat(this._logTag," ")).call(i,n.vid," ")).call(t,e):R()(r="[MP4]".concat(this._logTag," ")).call(r,e),o=arguments.length,l=new Array(o>1?o-1:0),d=1;d<o;d++)l[d-1]=arguments[d];Y.cM.apply(void 0,R()(a=[s]).call(a,l))}},{key:"errorHandler",value:(d=(0,C.Z)(O().mark((function e(t,i){var r,a,n,s,o,l,d,u,h=arguments;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=h.length>2&&h[2]!==undefined?h[2]:{},a=t.response,n=t.message,this.options&&this.options.vid,s=null,this._isPending=!0,!a){e.next=32;break}if(o=(0,z.x)(a.headers),s=new G.oO("network",a.status,{httpText:a.httpText,message:n,url:a.url,headers:o}),!(this.backUrl&&this.backUrl.length>0)){e.next=28;break}if(l=this.backUrl.shift(),this.update(l),this._isPending=!1,!this.MP4Loader){e.next=17;break}return e.next=17,this.MP4Loader.changeUrl(this.url,this.url+"-"+this._bitRate,this.CHUNK_SIZE);case 17:if(this.emit(ee.TASK_PROGRESS,{type:"error",error:t}),"getMetaInfo"!==i){e.next=23;break}return this.getMetaInfo(),e.abrupt("return");case 23:if("loadFragment"!==i){e.next=28;break}if(d=r.index,u=r.range,!d||!u){e.next=28;break}return this.loadFragment(d,u),e.abrupt("return");case 28:this.emit("error",s),e.next=35;break;case 32:s=t,this.emit("error",s);case 35:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"init",value:(o=(0,C.Z)(O().mark((function e(t){var i,r,a,n,s,o,l;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.url){e.next=3;break}return e.next=3,this.MP4Loader.changeUrl(this.url,this.options.vid+"-"+this._bitRate,this.CHUNK_SIZE);case 3:if(this.meta=null,i=t.meta,r=t.mediaSegList,a=t.buffer,n=t.fileSize,s=t.initSeg,o=t.bitrate,!i||!i.ext){e.next=20;break}this.meta=i,this._bitRate=o,this.videoTrak=i.ext.videoTrak,this.audioTrak=i.ext.audioTrak,this.timeRange=this.getTimeRange(),r?this.preloadCache={segList:r||[],initSeg:s}:a&&(this.size=n,this.bufferLoaded=a),l={meta:i,videoSegments:i.ext.videoTrak,audioSegments:i.ext.audioTrak,bufferLoaded:a||null},this._bitRateInfoMap.set(this._bitRate,l),(new Date).getTime(),x()((function(){})),this.emit("metaReady",this.meta),e.next=22;break;case 20:return e.next=22,this.getMetaInfo();case 22:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"getTimeRange",value:function(){for(var e=[],t=null,i=0;this.videoTrak&&i<this.videoTrak.length;i++)t={startTime:this.videoTrak[i].startTime,endTime:this.videoTrak[i].endTime,downloaded:!1,isLoading:!1},e.push(t);if(this.audioTrak&&this.audioTrak.length>e.length)for(var r=e.length;r<this.audioTrak.length;r++)t={startTime:Math.max(this.audioTrak[r].startTime,t?t.endTime:0),endTime:Math.max(this.audioTrak[r].endTime,t?t.endTime:0),downloaded:!1,isLoading:!1},e.push(t);return e}},{key:"getMetaInfo",value:(s=(0,C.Z)(O().mark((function e(){var t,i,r,a,n=this,s=arguments;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=!(s.length>0&&s[0]!==undefined)||s[0],e.prev=1,i=j.Z.nowTime(),this._metaLoading=!0,this.log("getMetaInfo start, bitRate,",this._bitRate),this.bufferLoaded=new Uint8Array(0),r=0,a=function(){var e=(0,C.Z)(O().mark((function e(a,s,o){var l;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.log("getMetaInfo onProgressHandle, dataLen,",a?a.byteLength:-1,", state,",s,",range,",o.range),a&&o.range[0]===r&&(n.bufferLoaded=N()(Uint8Array,n.bufferLoaded,new Uint8Array(a)),r+=a.byteLength),o.meta&&!n.meta&&(n.firstFrameTime.metaload=j.Z.nowTime()-i,l=o.meta,n.videoTrak=l.videoSegments,n.audioTrak=l.audioSegments,n.timeRange=n.getTimeRange(),n.meta=$($({},l.meta),{},{ext:{videoTrak:n.videoTrak,audioTrak:n.audioTrak}}),l.bufferLoaded=n.bufferLoaded,n._bitRateInfoMap.set(n._bitRate,l),n.log("meta reach, bitRate,",n._bitRate),t&&n.emit("metaReady",n.meta)),n.meta&&s&&(n.log("[getMetaInfo req end]"),n._metaLoading=!1),n.meta&&(a||s)&&(n.log("emit moov_req_progress"),n.emit(ee.MOOV_REQ_PROGRESS));case 5:case"end":return e.stop()}}),e)})));return function(t,i,r){return e.apply(this,arguments)}}(),e.next=10,this.MP4Loader.loadMetaProcess(this.MP4Loader.cache,[0,this.CHUNK_SIZE],a);case 10:e.next=16;break;case 12:e.prev=12,e.t0=e.catch(1),this.errorHandler(e.t0,"getMetaInfo");case 16:case"end":return e.stop()}}),e,this,[[1,12]])}))),function(){return s.apply(this,arguments)})},{key:"getFragmentIdx",value:function(e){var t,i,r;if(this.videoTrak.length){var a,n;if(t=w()(a=this.videoTrak).call(a,(function(t){return t.startTime<=e&&t.endTime>e})),i=w()(n=this.audioTrak).call(n,(function(t){return t.startTime<=e&&t.endTime>e})),t&&i)return Math.min(t.index,i.index);if(t||i)return t?t.index:i.index;var s=Number.MAX_VALUE;return this.videoTrak&&this.videoTrak.length>0&&(s=this.videoTrak.length-1),this.audioTrak&&this.audioTrak.length>0&&(s=Math.min(this.audioTrak.length-1,s)),s}return(i=w()(r=this.audioTrak).call(r,(function(t){return t.startTime<=e&&t.endTime>e})))?i.index:0}},{key:"_checkHasMeta",value:(n=(0,C.Z)(O().mark((function e(){var t,i;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this._bitRateInfoMap.get(this._bitRate)){e.next=18;break}return this.log("[ABR], need load InitSegment, bitRate, ",this._bitRate),this._metaLoading=!0,e.next=6,this.MP4Loader.loadMeta(this.MP4Loader.cache,Math.round(this.CHUNK_SIZE/2));case 6:return i=e.sent,this._metaLoading=!1,this.videoTrak=i.videoSegments,this.audioTrak=i.audioSegments,this.meta=$($({},i.meta),{},{ext:{videoTrak:this.videoTrak,audioTrak:this.audioTrak}}),this.timeRange=this.getTimeRange(),this.bufferLoaded=new Uint8Array(0),i.bufferLoaded=this.bufferLoaded,this._bitRateInfoMap.set(this._bitRate,i),e.abrupt("return",!0);case 18:return this.log("[ABR], not need load InitSegment, bitRate, ",this._bitRate),this.videoTrak=t.videoSegments,this.audioTrak=t.audioSegments,this.meta=t.meta,this.timeRange=this.getTimeRange(),this.bufferLoaded=new Uint8Array(0),e.abrupt("return",!0);case 25:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"resetFragmentLoadState",value:function(e){for(var t=0;t<this.timeRange.length;t++)t<e?(this.timeRange[t].downloaded=!0,this.timeRange[t].isLoading=!0):(this.timeRange[t].downloaded=!1,this.timeRange[t].isLoading=!1)}},{key:"getFragRange",value:function(e){var t,i,r,a,n=null;this.videoTrak&&(n=e<this.videoTrak.length?this.videoTrak[e]:this.videoTrak[this.videoTrak.length-1]);var s=null;this.audioTrak&&(s=e<this.audioTrak.length?this.audioTrak[e]:this.audioTrak[this.audioTrak.length-1]);var o=0,l=0;this.videoTrak&&e===this.videoTrak.length-1&&(o=-1),this.audioTrak&&e===this.audioTrak.length-1&&(l=-1);var d=[Math.min((null===(t=n)||void 0===t?void 0:t.range[0])||Infinity,(null===(i=s)||void 0===i?void 0:i.range[0])||Infinity),Math.max((null===(r=n)||void 0===r?void 0:r.range[1])+o||0,(null===(a=s)||void 0===a?void 0:a.range[1])+l||0)];return this.timeRange[e].range=d,d}},{key:"load",value:(r=(0,C.Z)(O().mark((function e(t,i,r){var a,n,s;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._loadSuccessCallBack=i,this._loadErrCallBack=r,!this._switchBitRate||this._metaLoading){e.next=16;break}return this._switchBitRate=!1,e.next=6,this._checkHasMeta();case 6:if(e.sent){e.next=9;break}return e.abrupt("return");case 9:this._needInitSegment=!0,this.MP4Demuxer&&this.MP4Demuxer.reset(),this.FMP4Remuxer&&this.FMP4Remuxer.reset(),this.transmuxerWorkerControl&&this.transmuxerWorkerControl.reset(),this._seekIdxWhenLoadingMoov>0&&(t=this._seekIdxWhenLoadingMoov,this._seekIdxWhenLoadingMoov=-1,this.log("[ABR], when loading moov, seek jump index,",t)),this.resetFragmentLoadState(t),this.log("[ABR], switch bitRate start load, bitRate,",this._bitRate,", time,",this.videoTrak[t].startTime,", fragIndex,",t);case 16:a=this.getFragRange(t),(n=this.getFragmentFromCache(t,a))?(this.log("[mp4.load], segment ,",t,"Data In Cache",a,", needInit,",this._needInitSegment),this.timeRange[t].downloaded=!0,this.timeRange[t].isLoading=!1,this._needInitSegment=!1,this._loadSuccessCallBack&&this._loadSuccessCallBack(n)):(this.log("loadFragment,",t,",bitRate,",this._bitRate,",range,",a),this.seekTime>0?(s=this.getSubRange(t,this.seekTime,a),this.loadFragment(t,s),this.seekTime=-1):this.loadFragment(t,a));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t,i){return r.apply(this,arguments)})},{key:"getSubRange",value:function(e,t,i){var r=i[0],a=i[0],n=1,s=!1;if(this.log(">>>>>getSubRange time,",t,i),this.videoTrak){var o,d=e<this.videoTrak.length?this.videoTrak[e]:this.videoTrak[this.videoTrak.length-1],u=l()(o=d.frames).call(o,ie),h=this.meta.videoTimescale,f=u[0].startTime/h;this.log(">>>>>getSubRange video, startTime,",d.startTime,",endTime,",d.endTime);for(var c=0;c<u.length;c++)this.log(">>>>>getSubRange video keyFrameList, startTime,",u[c].startTime/h,",range,",u[c].offset);for(;n<u.length;n++){var m=u[n].startTime/h;if(f<=t&&t<m&&i[0]<u[n-1].offset){r=u[n-1].offset,s=!0,this.log(">>>>>getSubRange video end, startTime,",f,",endTime,",m,",startRange,",r,", keyFrameIndex,",n-1);break}f=m}!s&&f<=t&&t<d.endTime+.8&&(r=u[n-1].offset,this.log(">>>>>getSubRange video last, startTime,",f,",endTime,",d.endTime,",startRange,",r))}if(n=1,this.audioTrak){var p=e<this.audioTrak.length?this.audioTrak[e]:this.audioTrak[this.audioTrak.length-1],g=p.frames,y=this.meta.audioTimescale;n=Math.floor((t*y-g[0].startTime)/p.frames[0].duration);for(var v=(n=Math.min(g.length-1,n))>0?g[n-1].startTime/y:g[0].startTime/y;n>=0&&n<g.length;)if(n>0&&v>t)v=g[n-=1].startTime/y;else{var _=(g[n].startTime+g[n].duration)/y;if(v<=t&&t<_&&i[0]<g[n].offset){a=g[n].offset,s=!0,this.log(">>>>>getSubRange audio end, startTime,",v,",endTime,",_,",startRange,",a,", index,",n);break}v=_,n++}}var T=[Math.min(a,r),i[1]];return this.log(">>>>>getSubRange finalRange ",T,",oldRange,",i),T}},{key:"getFragmentFromCache",value:function(e,t){var i=this.preloadCache;if(!i||!i.segList)return null;for(var r=-1,a=i.segList,n=i.initSeg,s=0;s<a.length;s++)if(a[s].index===e){r=s;break}if(r<0)return null;var o=a[r];if(o.range[1]>=t[1]){var l=[this.timeRange[e].startTime,this.timeRange[e].endTime]||0;return{buffer:o.buffer,range:t,context:{range:t,fragIndex:e,state:!0,timeRange:[l[0],l[1]]},state:!0,initSeg:this._needInitSegment?n:undefined}}return null}},{key:"_mux",value:function(e,t,i,r,a){var n=this;this.firstFrameTime.firstmux<0&&this.timeRecord.startMuxTime<0&&(this.timeRecord.startMuxTime=j.Z.nowTime(),this.firstFrameTime.startMuxTime=j.Z.nowTime()-this.timeRecord.startLoadTime);var s=this.getSamplesRange(i,"video"),o=this.getSamplesRange(i,"audio");if(this.transmuxerWorkerControl)!this.eventListen&&this.transmuxerWorkerControl.on("transmux",(function(s){var o=[t,t+e.byteLength],l={buffer:s.args.buffer,range:o,state:r,context:{range:o,fragIndex:i,startPts:s.args.startPts,endPts:s.args.endPts},initSeg:s.args.initSeg};n.log("[transmuxerworker] ,range, ",o,",dataLen,",l.buffer.byteLength),n.firstFrameTime.firstmux<0&&n.timeRecord.startMuxTime>0&&(n.firstFrameTime.firstmux=j.Z.nowTime()-n.timeRecord.startMuxTime),a?a(l):n._loadSuccessCallBack&&n._loadSuccessCallBack(l)})),this.eventListen=!0,this.transmuxerWorkerControl.transmux(this.workerSequence,e,t,s,o,this.meta.moov,this.useEME,this.kidValue);else try{this.MP4Demuxer||(this.MP4Demuxer=new K._(this.videoTrak,this.audioTrak,null,{openLog:(0,Y.qw)()}));var l=this.MP4Demuxer.demuxPart(e,t,s,o,this.meta.moov,this.useEME,this.kidValue);this.checkCodecH265()||this.FMP4Remuxer||(this.FMP4Remuxer=new W.N(this.MP4Demuxer.videoTrack,this.MP4Demuxer.audioTrack,{openLog:(0,Y.qw)()}));var d,u=[t,t+e.byteLength];this.log("[mux], videoTimeRange,",l.videoTrack?[l.videoTrack.startPts,l.videoTrack.endPts]:null,",audioTimeRange,",l.audioTrack?[l.audioTrack.startPts,l.audioTrack.endPts]:null);var h=[Math.min(l.videoTrack.startPts,l.audioTrack.startPts),Math.max(l.videoTrack.endPts,l.audioTrack.endPts)];if(this.FMP4Remuxer){var f=this.FMP4Remuxer.remux(this._needInitSegment,{initMerge:!0,range:u});f.initSegment&&(this._needInitSegment=!1),d={buffer:j.Z.concatData(f.audioSegment,f.videoSegment),range:u,state:r,context:{range:u,fragIndex:i,timeRange:h},initSeg:f.initSegment}}else d={videoTrack:l.videoTrack,audioTrack:l.audioTrack,buffer:null,range:u,state:r,context:{range:u,fragIndex:i,timeRange:h}};this.firstFrameTime.firstmux<0&&this.timeRecord.startMuxTime>0&&(this.firstFrameTime.firstmux=j.Z.nowTime()-this.timeRecord.startMuxTime),a?a(d):this._loadSuccessCallBack&&this._loadSuccessCallBack(d)}catch(c){this.errorHandler(c,"mux",{fragIndex:i,range:[t,t+e.byteLength]})}}},{key:"loadFragment",value:(i=(0,C.Z)(O().mark((function e(t,i){var r,a,n,s;return O().wrap((function(e){for(var o,l;;)switch(e.prev=e.next){case 0:if(!this._isPending&&i!==[0,0]&&!this.timeRange[t].isLoading){e.next=2;break}return e.abrupt("return");case 2:if(this.log("[MP4.loadFragment] ,fragIndex,",t,",range ",i,",len ,",i[1]-i[0],", bufferLoaded_Len,",this.bufferLoaded.byteLength),this._segmentToBitRateMap.set(t,this._bitRate),this.timeRecord.startLoadTime<0&&(this.timeRecord.startLoadTime=j.Z.nowTime()),!(i.length>=2&&i[1]&&i[1]>0&&i[1]<=this.bufferLoaded.byteLength)){e.next=15;break}this.timeRange[t].isLoading=!0,r=Math.max(i[0],this.bufferLoadedPos),a=new Uint8Array(S()(o=this.bufferLoaded).call(o,r,i[1])),this.log("[mp4.loadFragment] has all data: ",r,i[1]),this.timeRange[t].downloaded=!0,this.bufferLoadedPos=-1,this._mux(a,r,t,!0),e.next=38;break;case 15:if(!(i.length>=2&&i[0]&&i[0]<=this.bufferLoaded.byteLength)){e.next=27;break}if(this.timeRange[t].isLoading){e.next=25;break}if(n=Math.max(i[0],this.bufferLoadedPos),!((s=new Uint8Array(S()(l=this.bufferLoaded).call(l,n,i[1]))).byteLength>0)){e.next=24;break}return this.bufferLoadedPos=n+s.byteLength,this.log("[mp4.loadFragment] has part data: ",n,n+s.byteLength),this._mux(s,n,t,i[1]<=this.bufferLoadedPos),e.abrupt("return");case 24:if(!this._metaLoading&&!this.timeRange[t].isLoading)try{this.log("[mp4.loadFragment] ready to load part data >>> ",this.bufferLoaded.byteLength,i[1]),this.timeRange[t].isLoading=!0,this.MP4Loader.loadData([this.bufferLoaded.byteLength,i[1]],this.MP4Loader.cache,{index:t,onProgress:this.onprogressDataArrive})}catch(d){this.errorHandler(d,"MP4Loader.loadData",{range:[this.bufferLoaded.byteLength,i[1]],fragIndex:t})}case 25:e.next=38;break;case 27:if(this._metaLoading&&!(i[0]>=this.CHUNK_SIZE)||this.timeRange[t].isLoading){e.next=38;break}return this.timeRange[t].isLoading=!0,this.log("[mp4.loadFragment],ready to load all data ,segmentIdx, ",t,",range >>> ",i),e.prev=30,e.next=33,this.MP4Loader.loadData(i,this.MP4Loader.cache,{index:t,onProgress:this.onprogressDataArrive});case 33:e.next=38;break;case 35:e.prev=35,e.t0=e.catch(30),this.errorHandler(e.t0,"MP4Loader.loadData",{range:i,fragIndex:t});case 38:case"end":return e.stop()}}),e,this,[[30,35]])}))),function(e,t){return i.apply(this,arguments)})},{key:"loadAllFragmentData",value:(t=(0,C.Z)(O().mark((function e(t,i,r){var a,n,s;return O().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.hasDestroyed){e.next=2;break}return e.abrupt("return");case 2:return a=this.getFragRange(t),e.prev=3,e.next=6,this.MP4Loader.loadData(a,this.MP4Loader.cache,{index:t});case 6:if(n=e.sent,this.log("loadAllFragmentData after",a,n),n&&n.data){e.next=11;break}return r(new Error("response null")),e.abrupt("return");case 11:s=n.data,this._mux(s,a[0],t,!0,i),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(3),r(e.t0);case 19:case"end":return e.stop()}}),e,this,[[3,15]])}))),function(e,i,r){return t.apply(this,arguments)})},{key:"cancelLoading",value:function(){this.MP4Loader&&this.MP4Loader.cancel()}},{key:"update",value:function(e){this.url=e}},{key:"getDataBitRate",value:function(e){return this._segmentToBitRateMap.get(e)}},{key:"checkCodecH265",value:function(){var e,t;return this.meta&&(I()(e=this.meta.videoCodec).call(e,"hvc1")>-1||I()(t=this.meta.videoCodec).call(t,"hev1")>-1)}},{key:"getSamplesRange",value:function(e,t){var i=[];switch(t){case"video":if(this.videoTrak&&e<this.videoTrak.length){var r=this.videoTrak[e].frames;i.push(r[0].index),i.push(r[r.length-1].index)}break;case"audio":if(this.audioTrak&&e<this.audioTrak.length){var a=this.audioTrak[e].frames;i.push(a[0].index),i.push(a[a.length-1].index)}}return i}},{key:"destroy",value:function(){this.hasDestroyed||(this.MP4Demuxer&&this.MP4Demuxer.reset(),this.MP4Demuxer=null,this.FMP4Remuxer&&this.FMP4Remuxer.reset(),this.FMP4Remuxer=null,this.transmuxerWorkerControl&&this.transmuxerWorkerControl.destroy(),this.transmuxerWorkerControl=null,this.size=0,this._isPending=!1,this._metaLoading=!1,this.bufferLoadedPos=0,this.bufferLoaded=null,this._bitRateInfoMap.clear(),this._segmentToBitRateMap.clear(),this.MP4Loader&&(this.MP4Loader.cancel(),this.MP4Loader.destroy()),this.hasDestroyed=!0)}}],[{key:"speed",get:function(){return q.b.speed()}},{key:"realTimeSpeed",get:function(){return q.b.realTimeSpeed()}},{key:"getDefaultConfig",value:function(){return{xhrSetup:null,chunkSize:819200,loadSize:800,isCache:!1,playerId:"",vid:"",ext:{}}}}]),e}();function ie(e){if(e.keyframe)return e}}}]);